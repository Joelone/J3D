/*

J3D, a Javascript/WebGL 3D egnine
Created by Bartek Drozdz <bartek@everydayflash.com>
http://www.everyday3d.com/j3d/ 

Uses the following libraries:

glMatrix, Copyright (c) 2010 Brandon Jone
http://code.google.com/p/glmatrix/

requestAnimationFrame
http://paulirish.com/2011/requestanimationframe-for-smart-animating/

*/
if(!window.requestAnimationFrame)window.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1E3/60)}}();(function(a,b){typeof exports==="object"?module.exports=b(global):typeof define==="function"&&define.amd?define([],function(){return b(a)}):b(a)})(this,function(a){function b(f){return e=f}function c(){return e=typeof Float32Array!=="undefined"?Float32Array:Array}var d={};(function(){if(typeof Float32Array!="undefined"){var f=new Float32Array(1),l=new Int32Array(f.buffer);d.invsqrt=function(a){f[0]=a;l[0]=1597463007-(l[0]>>1);var b=f[0];return b*(1.5-a*0.5*b*b)}}else d.invsqrt=function(f){return 1/
Math.sqrt(f)}})();var e=null;c();var g={};g.create=function(f){var l=new e(3);f?(l[0]=f[0],l[1]=f[1],l[2]=f[2]):l[0]=l[1]=l[2]=0;return l};g.createFrom=function(f,l,a){var b=new e(3);b[0]=f;b[1]=l;b[2]=a;return b};g.set=function(f,l){l[0]=f[0];l[1]=f[1];l[2]=f[2];return l};g.equal=function(f,l){return f===l||Math.abs(f[0]-l[0])<1.0E-6&&Math.abs(f[1]-l[1])<1.0E-6&&Math.abs(f[2]-l[2])<1.0E-6};g.add=function(f,l,a){if(!a||f===a)return f[0]+=l[0],f[1]+=l[1],f[2]+=l[2],f;a[0]=f[0]+l[0];a[1]=f[1]+l[1];
a[2]=f[2]+l[2];return a};g.subtract=function(f,l,a){if(!a||f===a)return f[0]-=l[0],f[1]-=l[1],f[2]-=l[2],f;a[0]=f[0]-l[0];a[1]=f[1]-l[1];a[2]=f[2]-l[2];return a};g.multiply=function(f,l,a){if(!a||f===a)return f[0]*=l[0],f[1]*=l[1],f[2]*=l[2],f;a[0]=f[0]*l[0];a[1]=f[1]*l[1];a[2]=f[2]*l[2];return a};g.negate=function(f,l){l||(l=f);l[0]=-f[0];l[1]=-f[1];l[2]=-f[2];return l};g.scale=function(f,l,a){if(!a||f===a)return f[0]*=l,f[1]*=l,f[2]*=l,f;a[0]=f[0]*l;a[1]=f[1]*l;a[2]=f[2]*l;return a};g.normalize=
function(f,l){l||(l=f);var a=f[0],b=f[1],c=f[2],d=Math.sqrt(a*a+b*b+c*c);if(d){if(d===1)return l[0]=a,l[1]=b,l[2]=c,l}else return l[0]=0,l[1]=0,l[2]=0,l;d=1/d;l[0]=a*d;l[1]=b*d;l[2]=c*d;return l};g.cross=function(f,l,a){a||(a=f);var b=f[0],c=f[1];f=f[2];var d=l[0],e=l[1];l=l[2];a[0]=c*l-f*e;a[1]=f*d-b*l;a[2]=b*e-c*d;return a};g.length=function(f){var l=f[0],a=f[1];f=f[2];return Math.sqrt(l*l+a*a+f*f)};g.squaredLength=function(f){var l=f[0],a=f[1];f=f[2];return l*l+a*a+f*f};g.dot=function(f,l){return f[0]*
l[0]+f[1]*l[1]+f[2]*l[2]};g.direction=function(f,l,a){a||(a=f);var b=f[0]-l[0],c=f[1]-l[1];f=f[2]-l[2];l=Math.sqrt(b*b+c*c+f*f);if(!l)return a[0]=0,a[1]=0,a[2]=0,a;l=1/l;a[0]=b*l;a[1]=c*l;a[2]=f*l;return a};g.lerp=function(f,l,a,b){b||(b=f);b[0]=f[0]+a*(l[0]-f[0]);b[1]=f[1]+a*(l[1]-f[1]);b[2]=f[2]+a*(l[2]-f[2]);return b};g.dist=function(f,l){var a=l[0]-f[0],b=l[1]-f[1],c=l[2]-f[2];return Math.sqrt(a*a+b*b+c*c)};var h=null,i=new e(4);g.unproject=function(f,l,a,b,c){c||(c=f);h||(h=o.create());var d=
h;i[0]=(f[0]-b[0])*2/b[2]-1;i[1]=(f[1]-b[1])*2/b[3]-1;i[2]=2*f[2]-1;i[3]=1;o.multiply(a,l,d);if(!o.inverse(d))return null;o.multiplyVec4(d,i);if(i[3]===0)return null;c[0]=i[0]/i[3];c[1]=i[1]/i[3];c[2]=i[2]/i[3];return c};var j=g.createFrom(1,0,0),q=g.createFrom(0,1,0),m=g.createFrom(0,0,1),p=g.create();g.rotationTo=function(f,l,a){a||(a=k.create());var b=g.dot(f,l);if(b>=1)k.set(r,a);else if(b<-0.999999)g.cross(j,f,p),g.length(p)<1.0E-6&&g.cross(q,f,p),g.length(p)<1.0E-6&&g.cross(m,f,p),g.normalize(p),
k.fromAngleAxis(Math.PI,p,a);else{b=Math.sqrt((1+b)*2);var c=1/b;g.cross(f,l,p);a[0]=p[0]*c;a[1]=p[1]*c;a[2]=p[2]*c;a[3]=b*0.5;k.normalize(a)}a[3]>1?a[3]=1:a[3]<-1&&(a[3]=-1);return a};g.str=function(f){return"["+f[0]+", "+f[1]+", "+f[2]+"]"};var n={};n.create=function(f){var l=new e(9);f?(l[0]=f[0],l[1]=f[1],l[2]=f[2],l[3]=f[3],l[4]=f[4],l[5]=f[5],l[6]=f[6],l[7]=f[7],l[8]=f[8]):l[0]=l[1]=l[2]=l[3]=l[4]=l[5]=l[6]=l[7]=l[8]=0;return l};n.createFrom=function(f,l,a,b,c,d,g,h,i){var j=new e(9);j[0]=f;
j[1]=l;j[2]=a;j[3]=b;j[4]=c;j[5]=d;j[6]=g;j[7]=h;j[8]=i;return j};n.determinant=function(f){var l=f[3],a=f[4],b=f[5],c=f[6],d=f[7],e=f[8];return f[0]*(e*a-b*d)+f[1]*(-e*l+b*c)+f[2]*(d*l-a*c)};n.inverse=function(f,l){var a=f[0],b=f[1],c=f[2],d=f[3],e=f[4],g=f[5],h=f[6],i=f[7],j=f[8],k=j*e-g*i,o=-j*d+g*h,p=i*d-e*h,m=a*k+b*o+c*p;if(!m)return null;m=1/m;l||(l=n.create());l[0]=k*m;l[1]=(-j*b+c*i)*m;l[2]=(g*b-c*e)*m;l[3]=o*m;l[4]=(j*a-c*h)*m;l[5]=(-g*a+c*d)*m;l[6]=p*m;l[7]=(-i*a+b*h)*m;l[8]=(e*a-b*d)*m;
return l};n.multiply=function(f,l,a){a||(a=f);var b=f[0],c=f[1],d=f[2],e=f[3],g=f[4],h=f[5],i=f[6],j=f[7];f=f[8];var k=l[0],n=l[1],m=l[2],o=l[3],p=l[4],q=l[5],t=l[6],r=l[7];l=l[8];a[0]=k*b+n*e+m*i;a[1]=k*c+n*g+m*j;a[2]=k*d+n*h+m*f;a[3]=o*b+p*e+q*i;a[4]=o*c+p*g+q*j;a[5]=o*d+p*h+q*f;a[6]=t*b+r*e+l*i;a[7]=t*c+r*g+l*j;a[8]=t*d+r*h+l*f;return a};n.multiplyVec2=function(f,a,b){b||(b=a);var c=a[0];a=a[1];b[0]=c*f[0]+a*f[3]+f[6];b[1]=c*f[1]+a*f[4]+f[7];return b};n.multiplyVec3=function(f,a,b){b||(b=a);var c=
a[0],d=a[1];a=a[2];b[0]=c*f[0]+d*f[3]+a*f[6];b[1]=c*f[1]+d*f[4]+a*f[7];b[2]=c*f[2]+d*f[5]+a*f[8];return b};n.set=function(f,a){a[0]=f[0];a[1]=f[1];a[2]=f[2];a[3]=f[3];a[4]=f[4];a[5]=f[5];a[6]=f[6];a[7]=f[7];a[8]=f[8];return a};n.equal=function(f,a){return f===a||Math.abs(f[0]-a[0])<1.0E-6&&Math.abs(f[1]-a[1])<1.0E-6&&Math.abs(f[2]-a[2])<1.0E-6&&Math.abs(f[3]-a[3])<1.0E-6&&Math.abs(f[4]-a[4])<1.0E-6&&Math.abs(f[5]-a[5])<1.0E-6&&Math.abs(f[6]-a[6])<1.0E-6&&Math.abs(f[7]-a[7])<1.0E-6&&Math.abs(f[8]-
a[8])<1.0E-6};n.identity=function(f){f||(f=n.create());f[0]=1;f[1]=0;f[2]=0;f[3]=0;f[4]=1;f[5]=0;f[6]=0;f[7]=0;f[8]=1;return f};n.transpose=function(f,a){if(!a||f===a){var b=f[1],c=f[2],d=f[5];f[1]=f[3];f[2]=f[6];f[3]=b;f[5]=f[7];f[6]=c;f[7]=d;return f}a[0]=f[0];a[1]=f[3];a[2]=f[6];a[3]=f[1];a[4]=f[4];a[5]=f[7];a[6]=f[2];a[7]=f[5];a[8]=f[8];return a};n.toMat4=function(f,a){a||(a=o.create());a[15]=1;a[14]=0;a[13]=0;a[12]=0;a[11]=0;a[10]=f[8];a[9]=f[7];a[8]=f[6];a[7]=0;a[6]=f[5];a[5]=f[4];a[4]=f[3];
a[3]=0;a[2]=f[2];a[1]=f[1];a[0]=f[0];return a};n.str=function(f){return"["+f[0]+", "+f[1]+", "+f[2]+", "+f[3]+", "+f[4]+", "+f[5]+", "+f[6]+", "+f[7]+", "+f[8]+"]"};var o={};o.create=function(f){var a=new e(16);f&&(a[0]=f[0],a[1]=f[1],a[2]=f[2],a[3]=f[3],a[4]=f[4],a[5]=f[5],a[6]=f[6],a[7]=f[7],a[8]=f[8],a[9]=f[9],a[10]=f[10],a[11]=f[11],a[12]=f[12],a[13]=f[13],a[14]=f[14],a[15]=f[15]);return a};o.createFrom=function(f,a,b,c,d,g,h,i,j,k,n,m,o,p,q,t){var r=new e(16);r[0]=f;r[1]=a;r[2]=b;r[3]=c;r[4]=
d;r[5]=g;r[6]=h;r[7]=i;r[8]=j;r[9]=k;r[10]=n;r[11]=m;r[12]=o;r[13]=p;r[14]=q;r[15]=t;return r};o.set=function(f,a){a[0]=f[0];a[1]=f[1];a[2]=f[2];a[3]=f[3];a[4]=f[4];a[5]=f[5];a[6]=f[6];a[7]=f[7];a[8]=f[8];a[9]=f[9];a[10]=f[10];a[11]=f[11];a[12]=f[12];a[13]=f[13];a[14]=f[14];a[15]=f[15];return a};o.equal=function(f,a){return f===a||Math.abs(f[0]-a[0])<1.0E-6&&Math.abs(f[1]-a[1])<1.0E-6&&Math.abs(f[2]-a[2])<1.0E-6&&Math.abs(f[3]-a[3])<1.0E-6&&Math.abs(f[4]-a[4])<1.0E-6&&Math.abs(f[5]-a[5])<1.0E-6&&
Math.abs(f[6]-a[6])<1.0E-6&&Math.abs(f[7]-a[7])<1.0E-6&&Math.abs(f[8]-a[8])<1.0E-6&&Math.abs(f[9]-a[9])<1.0E-6&&Math.abs(f[10]-a[10])<1.0E-6&&Math.abs(f[11]-a[11])<1.0E-6&&Math.abs(f[12]-a[12])<1.0E-6&&Math.abs(f[13]-a[13])<1.0E-6&&Math.abs(f[14]-a[14])<1.0E-6&&Math.abs(f[15]-a[15])<1.0E-6};o.identity=function(f){f||(f=o.create());f[0]=1;f[1]=0;f[2]=0;f[3]=0;f[4]=0;f[5]=1;f[6]=0;f[7]=0;f[8]=0;f[9]=0;f[10]=1;f[11]=0;f[12]=0;f[13]=0;f[14]=0;f[15]=1;return f};o.transpose=function(f,a){if(!a||f===a){var b=
f[1],c=f[2],d=f[3],e=f[6],g=f[7],h=f[11];f[1]=f[4];f[2]=f[8];f[3]=f[12];f[4]=b;f[6]=f[9];f[7]=f[13];f[8]=c;f[9]=e;f[11]=f[14];f[12]=d;f[13]=g;f[14]=h;return f}a[0]=f[0];a[1]=f[4];a[2]=f[8];a[3]=f[12];a[4]=f[1];a[5]=f[5];a[6]=f[9];a[7]=f[13];a[8]=f[2];a[9]=f[6];a[10]=f[10];a[11]=f[14];a[12]=f[3];a[13]=f[7];a[14]=f[11];a[15]=f[15];return a};o.determinant=function(f){var a=f[0],b=f[1],c=f[2],d=f[3],e=f[4],g=f[5],h=f[6],i=f[7],j=f[8],k=f[9],n=f[10],m=f[11],o=f[12],p=f[13],q=f[14];f=f[15];return o*k*h*
d-j*p*h*d-o*g*n*d+e*p*n*d+j*g*q*d-e*k*q*d-o*k*c*i+j*p*c*i+o*b*n*i-a*p*n*i-j*b*q*i+a*k*q*i+o*g*c*m-e*p*c*m-o*b*h*m+a*p*h*m+e*b*q*m-a*g*q*m-j*g*c*f+e*k*c*f+j*b*h*f-a*k*h*f-e*b*n*f+a*g*n*f};o.inverse=function(f,a){a||(a=f);var b=f[0],c=f[1],d=f[2],e=f[3],g=f[4],h=f[5],i=f[6],j=f[7],k=f[8],n=f[9],m=f[10],o=f[11],p=f[12],q=f[13],r=f[14],t=f[15],u=b*h-c*g,v=b*i-d*g,w=b*j-e*g,x=c*i-d*h,J=c*j-e*h,K=d*j-e*i,L=k*q-n*p,M=k*r-m*p,N=k*t-o*p,S=n*r-m*q,T=n*t-o*q,U=m*t-o*r,A=u*U-v*T+w*S+x*N-J*M+K*L;if(!A)return null;
A=1/A;a[0]=(h*U-i*T+j*S)*A;a[1]=(-c*U+d*T-e*S)*A;a[2]=(q*K-r*J+t*x)*A;a[3]=(-n*K+m*J-o*x)*A;a[4]=(-g*U+i*N-j*M)*A;a[5]=(b*U-d*N+e*M)*A;a[6]=(-p*K+r*w-t*v)*A;a[7]=(k*K-m*w+o*v)*A;a[8]=(g*T-h*N+j*L)*A;a[9]=(-b*T+c*N-e*L)*A;a[10]=(p*J-q*w+t*u)*A;a[11]=(-k*J+n*w-o*u)*A;a[12]=(-g*S+h*M-i*L)*A;a[13]=(b*S-c*M+d*L)*A;a[14]=(-p*x+q*v-r*u)*A;a[15]=(k*x-n*v+m*u)*A;return a};o.toRotationMat=function(f,a){a||(a=o.create());a[0]=f[0];a[1]=f[1];a[2]=f[2];a[3]=f[3];a[4]=f[4];a[5]=f[5];a[6]=f[6];a[7]=f[7];a[8]=f[8];
a[9]=f[9];a[10]=f[10];a[11]=f[11];a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a};o.toMat3=function(f,a){a||(a=n.create());a[0]=f[0];a[1]=f[1];a[2]=f[2];a[3]=f[4];a[4]=f[5];a[5]=f[6];a[6]=f[8];a[7]=f[9];a[8]=f[10];return a};o.toInverseMat3=function(f,a){var b=f[0],c=f[1],d=f[2],e=f[4],g=f[5],h=f[6],i=f[8],j=f[9],k=f[10],m=k*g-h*j,o=-k*e+h*i,p=j*e-g*i,q=b*m+c*o+d*p;if(!q)return null;q=1/q;a||(a=n.create());a[0]=m*q;a[1]=(-k*c+d*j)*q;a[2]=(h*c-d*g)*q;a[3]=o*q;a[4]=(k*b-d*i)*q;a[5]=(-h*b+d*e)*q;a[6]=p*q;a[7]=
(-j*b+c*i)*q;a[8]=(g*b-c*e)*q;return a};o.multiply=function(a,b,c){c||(c=a);var d=a[0],e=a[1],g=a[2],h=a[3],i=a[4],j=a[5],k=a[6],m=a[7],o=a[8],n=a[9],p=a[10],q=a[11],r=a[12],t=a[13],u=a[14];a=a[15];var v=b[0],z=b[1],w=b[2],x=b[3];c[0]=v*d+z*i+w*o+x*r;c[1]=v*e+z*j+w*n+x*t;c[2]=v*g+z*k+w*p+x*u;c[3]=v*h+z*m+w*q+x*a;v=b[4];z=b[5];w=b[6];x=b[7];c[4]=v*d+z*i+w*o+x*r;c[5]=v*e+z*j+w*n+x*t;c[6]=v*g+z*k+w*p+x*u;c[7]=v*h+z*m+w*q+x*a;v=b[8];z=b[9];w=b[10];x=b[11];c[8]=v*d+z*i+w*o+x*r;c[9]=v*e+z*j+w*n+x*t;c[10]=
v*g+z*k+w*p+x*u;c[11]=v*h+z*m+w*q+x*a;v=b[12];z=b[13];w=b[14];x=b[15];c[12]=v*d+z*i+w*o+x*r;c[13]=v*e+z*j+w*n+x*t;c[14]=v*g+z*k+w*p+x*u;c[15]=v*h+z*m+w*q+x*a;return c};o.multiplyVec3=function(a,b,c){c||(c=b);var d=b[0],e=b[1];b=b[2];c[0]=a[0]*d+a[4]*e+a[8]*b+a[12];c[1]=a[1]*d+a[5]*e+a[9]*b+a[13];c[2]=a[2]*d+a[6]*e+a[10]*b+a[14];return c};o.multiplyVec4=function(a,b,c){c||(c=b);var d=b[0],e=b[1],g=b[2];b=b[3];c[0]=a[0]*d+a[4]*e+a[8]*g+a[12]*b;c[1]=a[1]*d+a[5]*e+a[9]*g+a[13]*b;c[2]=a[2]*d+a[6]*e+a[10]*
g+a[14]*b;c[3]=a[3]*d+a[7]*e+a[11]*g+a[15]*b;return c};o.translate=function(a,b,c){var d=b[0],e=b[1];b=b[2];var g,h,i,j,k,m,o,n,p,q,r,t;if(!c||a===c)return a[12]=a[0]*d+a[4]*e+a[8]*b+a[12],a[13]=a[1]*d+a[5]*e+a[9]*b+a[13],a[14]=a[2]*d+a[6]*e+a[10]*b+a[14],a[15]=a[3]*d+a[7]*e+a[11]*b+a[15],a;g=a[0];h=a[1];i=a[2];j=a[3];k=a[4];m=a[5];o=a[6];n=a[7];p=a[8];q=a[9];r=a[10];t=a[11];c[0]=g;c[1]=h;c[2]=i;c[3]=j;c[4]=k;c[5]=m;c[6]=o;c[7]=n;c[8]=p;c[9]=q;c[10]=r;c[11]=t;c[12]=g*d+k*e+p*b+a[12];c[13]=h*d+m*e+
q*b+a[13];c[14]=i*d+o*e+r*b+a[14];c[15]=j*d+n*e+t*b+a[15];return c};o.scale=function(a,b,c){var d=b[0],e=b[1];b=b[2];if(!c||a===c)return a[0]*=d,a[1]*=d,a[2]*=d,a[3]*=d,a[4]*=e,a[5]*=e,a[6]*=e,a[7]*=e,a[8]*=b,a[9]*=b,a[10]*=b,a[11]*=b,a;c[0]=a[0]*d;c[1]=a[1]*d;c[2]=a[2]*d;c[3]=a[3]*d;c[4]=a[4]*e;c[5]=a[5]*e;c[6]=a[6]*e;c[7]=a[7]*e;c[8]=a[8]*b;c[9]=a[9]*b;c[10]=a[10]*b;c[11]=a[11]*b;c[12]=a[12];c[13]=a[13];c[14]=a[14];c[15]=a[15];return c};o.rotate=function(a,b,c,d){var e=c[0],g=c[1];c=c[2];var h=
Math.sqrt(e*e+g*g+c*c),i,j,k,m,o,n,p,q,r,t,u,v,z,w,x,J,K,L,M,N;if(!h)return null;h!==1&&(h=1/h,e*=h,g*=h,c*=h);i=Math.sin(b);j=Math.cos(b);k=1-j;b=a[0];h=a[1];m=a[2];o=a[3];n=a[4];p=a[5];q=a[6];r=a[7];t=a[8];u=a[9];v=a[10];z=a[11];w=e*e*k+j;x=g*e*k+c*i;J=c*e*k-g*i;K=e*g*k-c*i;L=g*g*k+j;M=c*g*k+e*i;N=e*c*k+g*i;e=g*c*k-e*i;g=c*c*k+j;d?a!==d&&(d[12]=a[12],d[13]=a[13],d[14]=a[14],d[15]=a[15]):d=a;d[0]=b*w+n*x+t*J;d[1]=h*w+p*x+u*J;d[2]=m*w+q*x+v*J;d[3]=o*w+r*x+z*J;d[4]=b*K+n*L+t*M;d[5]=h*K+p*L+u*M;d[6]=
m*K+q*L+v*M;d[7]=o*K+r*L+z*M;d[8]=b*N+n*e+t*g;d[9]=h*N+p*e+u*g;d[10]=m*N+q*e+v*g;d[11]=o*N+r*e+z*g;return d};o.rotateX=function(a,b,c){var d=Math.sin(b);b=Math.cos(b);var e=a[4],g=a[5],h=a[6],i=a[7],j=a[8],k=a[9],m=a[10],o=a[11];c?a!==c&&(c[0]=a[0],c[1]=a[1],c[2]=a[2],c[3]=a[3],c[12]=a[12],c[13]=a[13],c[14]=a[14],c[15]=a[15]):c=a;c[4]=e*b+j*d;c[5]=g*b+k*d;c[6]=h*b+m*d;c[7]=i*b+o*d;c[8]=e*-d+j*b;c[9]=g*-d+k*b;c[10]=h*-d+m*b;c[11]=i*-d+o*b;return c};o.rotateY=function(a,b,c){var d=Math.sin(b);b=Math.cos(b);
var e=a[0],g=a[1],h=a[2],i=a[3],j=a[8],k=a[9],m=a[10],o=a[11];c?a!==c&&(c[4]=a[4],c[5]=a[5],c[6]=a[6],c[7]=a[7],c[12]=a[12],c[13]=a[13],c[14]=a[14],c[15]=a[15]):c=a;c[0]=e*b+j*-d;c[1]=g*b+k*-d;c[2]=h*b+m*-d;c[3]=i*b+o*-d;c[8]=e*d+j*b;c[9]=g*d+k*b;c[10]=h*d+m*b;c[11]=i*d+o*b;return c};o.rotateZ=function(a,b,c){var d=Math.sin(b);b=Math.cos(b);var e=a[0],g=a[1],h=a[2],i=a[3],j=a[4],k=a[5],m=a[6],o=a[7];c?a!==c&&(c[8]=a[8],c[9]=a[9],c[10]=a[10],c[11]=a[11],c[12]=a[12],c[13]=a[13],c[14]=a[14],c[15]=a[15]):
c=a;c[0]=e*b+j*d;c[1]=g*b+k*d;c[2]=h*b+m*d;c[3]=i*b+o*d;c[4]=e*-d+j*b;c[5]=g*-d+k*b;c[6]=h*-d+m*b;c[7]=i*-d+o*b;return c};o.frustum=function(a,b,c,d,e,g,h){h||(h=o.create());var i=b-a,j=d-c,k=g-e;h[0]=e*2/i;h[1]=0;h[2]=0;h[3]=0;h[4]=0;h[5]=e*2/j;h[6]=0;h[7]=0;h[8]=(b+a)/i;h[9]=(d+c)/j;h[10]=-(g+e)/k;h[11]=-1;h[12]=0;h[13]=0;h[14]=-(g*e*2)/k;h[15]=0;return h};o.perspective=function(a,b,c,d,e){a=c*Math.tan(a*Math.PI/360);b*=a;return o.frustum(-b,b,-a,a,c,d,e)};o.ortho=function(a,b,c,d,e,g,h){h||(h=
o.create());var i=b-a,j=d-c,k=g-e;h[0]=2/i;h[1]=0;h[2]=0;h[3]=0;h[4]=0;h[5]=2/j;h[6]=0;h[7]=0;h[8]=0;h[9]=0;h[10]=-2/k;h[11]=0;h[12]=-(a+b)/i;h[13]=-(d+c)/j;h[14]=-(g+e)/k;h[15]=1;return h};o.lookAt=function(a,b,c,d){d||(d=o.create());var e,g,h,i,j,k,m,n,p=a[0],q=a[1];a=a[2];h=c[0];i=c[1];g=c[2];m=b[0];c=b[1];e=b[2];if(p===m&&q===c&&a===e)return o.identity(d);b=p-m;c=q-c;m=a-e;n=1/Math.sqrt(b*b+c*c+m*m);b*=n;c*=n;m*=n;e=i*m-g*c;g=g*b-h*m;h=h*c-i*b;(n=Math.sqrt(e*e+g*g+h*h))?(n=1/n,e*=n,g*=n,h*=n):
h=g=e=0;i=c*h-m*g;j=m*e-b*h;k=b*g-c*e;(n=Math.sqrt(i*i+j*j+k*k))?(n=1/n,i*=n,j*=n,k*=n):k=j=i=0;d[0]=e;d[1]=i;d[2]=b;d[3]=0;d[4]=g;d[5]=j;d[6]=c;d[7]=0;d[8]=h;d[9]=k;d[10]=m;d[11]=0;d[12]=-(e*p+g*q+h*a);d[13]=-(i*p+j*q+k*a);d[14]=-(b*p+c*q+m*a);d[15]=1;return d};o.lookAt2=function(a,b,c,d){a=a.sub(b).norm();if(a.mag()===0)a.z=1;b=v3.cross(c,a).norm();b.mag()===0&&(a.x+=1.0E-4,b=v3.cross(c,a).norm());c=v3.cross(a,b);d[0]=b.x;d[4]=c.x;d[8]=a.x;d[1]=b.y;d[5]=c.y;d[9]=a.y;d[2]=b.z;d[6]=c.z;d[10]=a.z;
return this};o.fromRotationTranslation=function(a,b,c){c||(c=o.create());var d=a[0],e=a[1],g=a[2],h=a[3],i=d+d,j=e+e,k=g+g;a=d*i;var m=d*j;d*=k;var n=e*j;e*=k;g*=k;i*=h;j*=h;h*=k;c[0]=1-(n+g);c[1]=m+h;c[2]=d-j;c[3]=0;c[4]=m-h;c[5]=1-(a+g);c[6]=e+i;c[7]=0;c[8]=d+j;c[9]=e-i;c[10]=1-(a+n);c[11]=0;c[12]=b[0];c[13]=b[1];c[14]=b[2];c[15]=1;return c};o.str=function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+", "+a[9]+", "+a[10]+", "+a[11]+", "+a[12]+
", "+a[13]+", "+a[14]+", "+a[15]+"]"};var k={};k.create=function(a){var b=new e(4);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3]):b[0]=b[1]=b[2]=b[3]=0;return b};k.createFrom=function(a,b,c,d){var g=new e(4);g[0]=a;g[1]=b;g[2]=c;g[3]=d;return g};k.set=function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];return b};k.equal=function(a,b){return a===b||Math.abs(a[0]-b[0])<1.0E-6&&Math.abs(a[1]-b[1])<1.0E-6&&Math.abs(a[2]-b[2])<1.0E-6&&Math.abs(a[3]-b[3])<1.0E-6};k.identity=function(a){a||(a=k.create());
a[0]=0;a[1]=0;a[2]=0;a[3]=1;return a};var r=k.identity();k.calculateW=function(a,b){var c=a[0],d=a[1],e=a[2];if(!b||a===b)return a[3]=-Math.sqrt(Math.abs(1-c*c-d*d-e*e)),a;b[0]=c;b[1]=d;b[2]=e;b[3]=-Math.sqrt(Math.abs(1-c*c-d*d-e*e));return b};k.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]};k.inverse=function(a,b){var c=a[0],d=a[1],e=a[2],g=a[3];c=(c=c*c+d*d+e*e+g*g)?1/c:0;if(!b||a===b)return a[0]*=-c,a[1]*=-c,a[2]*=-c,a[3]*=c,a;b[0]=-a[0]*c;b[1]=-a[1]*c;b[2]=-a[2]*c;b[3]=a[3]*
c;return b};k.conjugate=function(a,b){if(!b||a===b)return a[0]*=-1,a[1]*=-1,a[2]*=-1,a;b[0]=-a[0];b[1]=-a[1];b[2]=-a[2];b[3]=a[3];return b};k.length=function(a){var b=a[0],c=a[1],d=a[2];a=a[3];return Math.sqrt(b*b+c*c+d*d+a*a)};k.normalize=function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],g=a[3],h=Math.sqrt(c*c+d*d+e*e+g*g);if(h===0)return b[0]=0,b[1]=0,b[2]=0,b[3]=0,b;h=1/h;b[0]=c*h;b[1]=d*h;b[2]=e*h;b[3]=g*h;return b};k.add=function(a,b,c){if(!c||a===c)return a[0]+=b[0],a[1]+=b[1],a[2]+=b[2],a[3]+=
b[3],a;c[0]=a[0]+b[0];c[1]=a[1]+b[1];c[2]=a[2]+b[2];c[3]=a[3]+b[3];return c};k.multiply=function(a,b,c){c||(c=a);var d=a[0],e=a[1],g=a[2];a=a[3];var h=b[0],i=b[1],j=b[2];b=b[3];c[0]=d*b+a*h+e*j-g*i;c[1]=e*b+a*i+g*h-d*j;c[2]=g*b+a*j+d*i-e*h;c[3]=a*b-d*h-e*i-g*j;return c};k.multiplyVec3=function(a,b,c){c||(c=b);var d=b[0],e=b[1],g=b[2];b=a[0];var h=a[1],i=a[2];a=a[3];var j=a*d+h*g-i*e,k=a*e+i*d-b*g,m=a*g+b*e-h*d;d=-b*d-h*e-i*g;c[0]=j*a+d*-b+k*-i-m*-h;c[1]=k*a+d*-h+m*-b-j*-i;c[2]=m*a+d*-i+j*-h-k*-b;
return c};k.scale=function(a,b,c){if(!c||a===c)return a[0]*=b,a[1]*=b,a[2]*=b,a[3]*=b,a;c[0]=a[0]*b;c[1]=a[1]*b;c[2]=a[2]*b;c[3]=a[3]*b;return c};k.toMat3=function(a,b){b||(b=n.create());var c=a[0],d=a[1],e=a[2],g=a[3],h=c+c,i=d+d,j=e+e,k=c*h,m=c*i;c*=j;var o=d*i;d*=j;e*=j;h*=g;i*=g;g*=j;b[0]=1-(o+e);b[1]=m+g;b[2]=c-i;b[3]=m-g;b[4]=1-(k+e);b[5]=d+h;b[6]=c+i;b[7]=d-h;b[8]=1-(k+o);return b};k.toMat4=function(a,b){b||(b=o.create());var c=a[0],d=a[1],e=a[2],g=a[3],h=c+c,i=d+d,j=e+e,k=c*h,m=c*i;c*=j;var n=
d*i;d*=j;e*=j;h*=g;i*=g;g*=j;b[0]=1-(n+e);b[1]=m+g;b[2]=c-i;b[3]=0;b[4]=m-g;b[5]=1-(k+e);b[6]=d+h;b[7]=0;b[8]=c+i;b[9]=d-h;b[10]=1-(k+n);b[11]=0;b[12]=0;b[13]=0;b[14]=0;b[15]=1;return b};k.slerp=function(a,b,c,d){d||(d=a);var e=a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3],g,h;if(Math.abs(e)>=1)return d!==a&&(d[0]=a[0],d[1]=a[1],d[2]=a[2],d[3]=a[3]),d;g=Math.acos(e);h=Math.sqrt(1-e*e);if(Math.abs(h)<0.0010)return d[0]=a[0]*0.5+b[0]*0.5,d[1]=a[1]*0.5+b[1]*0.5,d[2]=a[2]*0.5+b[2]*0.5,d[3]=a[3]*0.5+b[3]*0.5,
d;e=Math.sin((1-c)*g)/h;c=Math.sin(c*g)/h;d[0]=a[0]*e+b[0]*c;d[1]=a[1]*e+b[1]*c;d[2]=a[2]*e+b[2]*c;d[3]=a[3]*e+b[3]*c;return d};k.fromRotationMatrix=function(a,b){b||(b=k.create());var c=a[0]+a[4]+a[8],d;if(c>0)d=Math.sqrt(c+1),b[3]=0.5*d,d=0.5/d,b[0]=(a[7]-a[5])*d,b[1]=(a[2]-a[6])*d,b[2]=(a[3]-a[1])*d;else{d=k.fromRotationMatrix.s_iNext=k.fromRotationMatrix.s_iNext||[1,2,0];c=0;a[4]>a[0]&&(c=1);a[8]>a[c*3+c]&&(c=2);var e=d[c],g=d[e];d=Math.sqrt(a[c*3+c]-a[e*3+e]-a[g*3+g]+1);b[c]=0.5*d;d=0.5/d;b[3]=
(a[g*3+e]-a[e*3+g])*d;b[e]=(a[e*3+c]+a[c*3+e])*d;b[g]=(a[g*3+c]+a[c*3+g])*d}return b};n.toQuat4=k.fromRotationMatrix;(function(){var a=n.create();k.fromAxes=function(b,c,d,e){a[0]=c[0];a[3]=c[1];a[6]=c[2];a[1]=d[0];a[4]=d[1];a[7]=d[2];a[2]=b[0];a[5]=b[1];a[8]=b[2];return k.fromRotationMatrix(a,e)}})();k.identity=function(a){a||(a=k.create());a[0]=0;a[1]=0;a[2]=0;a[3]=1;return a};k.fromAngleAxis=function(a,b,c){c||(c=k.create());a*=0.5;var d=Math.sin(a);c[3]=Math.cos(a);c[0]=d*b[0];c[1]=d*b[1];c[2]=
d*b[2];return c};k.toAngleAxis=function(a,b){b||(b=a);var c=a[0]*a[0]+a[1]*a[1]+a[2]*a[2];c>0?(b[3]=2*Math.acos(a[3]),c=d.invsqrt(c),b[0]=a[0]*c,b[1]=a[1]*c,b[2]=a[2]*c):(b[3]=0,b[0]=1,b[1]=0,b[2]=0);return b};k.str=function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+"]"};var t={};t.create=function(a){var b=new e(2);a?(b[0]=a[0],b[1]=a[1]):(b[0]=0,b[1]=0);return b};t.createFrom=function(a,b){var c=new e(2);c[0]=a;c[1]=b;return c};t.add=function(a,b,c){c||(c=b);c[0]=a[0]+b[0];c[1]=a[1]+b[1];return c};
t.subtract=function(a,b,c){c||(c=b);c[0]=a[0]-b[0];c[1]=a[1]-b[1];return c};t.multiply=function(a,b,c){c||(c=b);c[0]=a[0]*b[0];c[1]=a[1]*b[1];return c};t.divide=function(a,b,c){c||(c=b);c[0]=a[0]/b[0];c[1]=a[1]/b[1];return c};t.scale=function(a,b,c){c||(c=a);c[0]=a[0]*b;c[1]=a[1]*b;return c};t.dist=function(a,b){var c=b[0]-a[0],d=b[1]-a[1];return Math.sqrt(c*c+d*d)};t.set=function(a,b){b[0]=a[0];b[1]=a[1];return b};t.equal=function(a,b){return a===b||Math.abs(a[0]-b[0])<1.0E-6&&Math.abs(a[1]-b[1])<
1.0E-6};t.negate=function(a,b){b||(b=a);b[0]=-a[0];b[1]=-a[1];return b};t.normalize=function(a,b){b||(b=a);var c=a[0]*a[0]+a[1]*a[1];c>0?(c=Math.sqrt(c),b[0]=a[0]/c,b[1]=a[1]/c):b[0]=b[1]=0;return b};t.cross=function(a,b,c){a=a[0]*b[1]-a[1]*b[0];if(!c)return a;c[0]=c[1]=0;c[2]=a;return c};t.length=function(a){var b=a[0];a=a[1];return Math.sqrt(b*b+a*a)};t.squaredLength=function(a){var b=a[0];a=a[1];return b*b+a*a};t.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]};t.direction=function(a,b,c){c||(c=a);
var d=a[0]-b[0];a=a[1]-b[1];b=d*d+a*a;if(!b)return c[0]=0,c[1]=0,c[2]=0,c;b=1/Math.sqrt(b);c[0]=d*b;c[1]=a*b;return c};t.lerp=function(a,b,c,d){d||(d=a);d[0]=a[0]+c*(b[0]-a[0]);d[1]=a[1]+c*(b[1]-a[1]);return d};t.str=function(a){return"["+a[0]+", "+a[1]+"]"};var u={};u.create=function(a){var b=new e(4);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3]):b[0]=b[1]=b[2]=b[3]=0;return b};u.createFrom=function(a,b,c,d){var g=new e(4);g[0]=a;g[1]=b;g[2]=c;g[3]=d;return g};u.set=function(a,b){b[0]=a[0];b[1]=a[1];
b[2]=a[2];b[3]=a[3];return b};u.equal=function(a,b){return a===b||Math.abs(a[0]-b[0])<1.0E-6&&Math.abs(a[1]-b[1])<1.0E-6&&Math.abs(a[2]-b[2])<1.0E-6&&Math.abs(a[3]-b[3])<1.0E-6};u.identity=function(a){a||(a=u.create());a[0]=1;a[1]=0;a[2]=0;a[3]=1;return a};u.transpose=function(a,b){if(!b||a===b){var c=a[1];a[1]=a[2];a[2]=c;return a}b[0]=a[0];b[1]=a[2];b[2]=a[1];b[3]=a[3];return b};u.determinant=function(a){return a[0]*a[3]-a[2]*a[1]};u.inverse=function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],g=a[3],
h=c*g-e*d;if(!h)return null;h=1/h;b[0]=g*h;b[1]=-d*h;b[2]=-e*h;b[3]=c*h;return b};u.multiply=function(a,b,c){c||(c=a);var d=a[0],e=a[1],g=a[2];a=a[3];c[0]=d*b[0]+e*b[2];c[1]=d*b[1]+e*b[3];c[2]=g*b[0]+a*b[2];c[3]=g*b[1]+a*b[3];return c};u.rotate=function(a,b,c){c||(c=a);var d=a[0],e=a[1],g=a[2];a=a[3];var h=Math.sin(b);b=Math.cos(b);c[0]=d*b+e*h;c[1]=d*-h+e*b;c[2]=g*b+a*h;c[3]=g*-h+a*b;return c};u.multiplyVec2=function(a,b,c){c||(c=b);var d=b[0];b=b[1];c[0]=d*a[0]+b*a[1];c[1]=d*a[2]+b*a[3];return c};
u.scale=function(a,b,c){c||(c=a);var d=a[1],e=a[2],g=a[3],h=b[0];b=b[1];c[0]=a[0]*h;c[1]=d*b;c[2]=e*h;c[3]=g*b;return c};u.str=function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+"]"};var v={};v.create=function(a){var b=new e(4);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3]):(b[0]=0,b[1]=0,b[2]=0,b[3]=0);return b};v.createFrom=function(a,b,c,d){var g=new e(4);g[0]=a;g[1]=b;g[2]=c;g[3]=d;return g};v.add=function(a,b,c){c||(c=b);c[0]=a[0]+b[0];c[1]=a[1]+b[1];c[2]=a[2]+b[2];c[3]=a[3]+b[3];return c};
v.subtract=function(a,b,c){c||(c=b);c[0]=a[0]-b[0];c[1]=a[1]-b[1];c[2]=a[2]-b[2];c[3]=a[3]-b[3];return c};v.multiply=function(a,b,c){c||(c=b);c[0]=a[0]*b[0];c[1]=a[1]*b[1];c[2]=a[2]*b[2];c[3]=a[3]*b[3];return c};v.divide=function(a,b,c){c||(c=b);c[0]=a[0]/b[0];c[1]=a[1]/b[1];c[2]=a[2]/b[2];c[3]=a[3]/b[3];return c};v.scale=function(a,b,c){c||(c=a);c[0]=a[0]*b;c[1]=a[1]*b;c[2]=a[2]*b;c[3]=a[3]*b;return c};v.set=function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];return b};v.equal=function(a,b){return a===
b||Math.abs(a[0]-b[0])<1.0E-6&&Math.abs(a[1]-b[1])<1.0E-6&&Math.abs(a[2]-b[2])<1.0E-6&&Math.abs(a[3]-b[3])<1.0E-6};v.negate=function(a,b){b||(b=a);b[0]=-a[0];b[1]=-a[1];b[2]=-a[2];b[3]=-a[3];return b};v.length=function(a){var b=a[0],c=a[1],d=a[2];a=a[3];return Math.sqrt(b*b+c*c+d*d+a*a)};v.squaredLength=function(a){var b=a[0],c=a[1],d=a[2];a=a[3];return b*b+c*c+d*d+a*a};v.lerp=function(a,b,c,d){d||(d=a);d[0]=a[0]+c*(b[0]-a[0]);d[1]=a[1]+c*(b[1]-a[1]);d[2]=a[2]+c*(b[2]-a[2]);d[3]=a[3]+c*(b[3]-a[3]);
return d};v.str=function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+"]"};if(a)a.glMatrixArrayType=e,a.MatrixArray=e,a.setMatrixArrayType=b,a.determineMatrixArrayType=c,a.glMath=d,a.vec2=t,a.vec3=g,a.vec4=v,a.mat2=u,a.mat3=n,a.mat4=o,a.quat4=k;return{glMatrixArrayType:e,MatrixArray:e,setMatrixArrayType:b,determineMatrixArrayType:c,glMath:d,vec2:t,vec3:g,vec4:v,mat2:u,mat3:n,mat4:o,quat4:k}});var J3D={};J3D.debug=!0;J3D.LightmapAtlas=[];J3D.SHADER_MAX_LIGHTS=4;J3D.RENDER_AS_OPAQUE=0;J3D.RENDER_AS_TRANSPARENT=1;var SQR=function(){return{twoPI:Math.PI*2,deg2rad:Math.PI/180,rad2deg:180/Math.PI}}();J3D.AssetLoader=function(){function a(a){e--;e<=0&&a(c.assets)}function b(b,c){b||(b={});var d=b.onLoad;b.onLoad=function(){a(c);d&&d()};return b}var c=this,d=[],e;this.assets={};this.addTexture=function(a,b,c){d.push({name:a,type:"texture",source:b,params:c||null})};this.addCubemap=function(a,b,c){d.push({name:a,type:"cubemap",faces:b,params:c||null})};this.addShader=function(a,b){d.push({name:a,type:"shader",path:b})};this.addJSON=function(a,b){d.push({name:a,type:"json",path:b})};this.load=function(g){e=
d.length;var h=a,i;for(i in d){var j=d[i];switch(j.type){case "texture":this.assets[j.name]=new J3D.Texture(j.source,b(j.params,g));break;case "cubemap":this.assets[j.name]=new J3D.Cubemap(j.faces,b(j.params,g));break;case "shader":var q=function(a){return function(b){c.assets[a]=b;h(g)}}(j.name);J3D.Loader.loadGLSL(j.path,q);break;case "json":q=function(a){return function(b){c.assets[a]=b;h(g)}}(j.name),J3D.Loader.loadJSON(j.path,q)}}}};J3D.BuiltinShaders=function(){var a={},b=J3D.ShaderUtil.parseGLSL(J3D.ShaderSource.Phong);b.color=J3D.Color.white;b.hasColorTexture=!1;a.Phong=b;b=J3D.ShaderUtil.parseGLSL(J3D.ShaderSource.Gouraud);b.color=J3D.Color.white;b.emissive=J3D.Color.black;b.hasColorTexture=!1;a.Gouraud=b;b=J3D.ShaderUtil.parseGLSL(J3D.ShaderSource.Lightmap);b.setup=function(a,b){for(var e in a.uniforms)e=="lightmapTexture"?J3D.ShaderUtil.setTexture(a,1,"lightmapTexture",J3D.LightmapAtlas[b.lightmapIndex]):e=="lightmapAtlas"&&
gl.uniform4fv(a.uniforms.lightmapAtlas.location,b.lightmapTileOffset);J3D.Shader.prototype.setup.call(this,a,b)};a.Lightmap=b;a.Reflective=J3D.ShaderUtil.parseGLSL(J3D.ShaderSource.Reflective);a.Skybox=J3D.ShaderUtil.parseGLSL(J3D.ShaderSource.Skybox);a.Vignette=J3D.ShaderUtil.parseGLSL(J3D.ShaderSource.Vignette);a.Normal2Color=J3D.ShaderUtil.parseGLSL(J3D.ShaderSource.Normal2Color);b=J3D.ShaderUtil.parseGLSL(J3D.ShaderSource.Selflit);b.color=J3D.Color.white;a.Selflit=b;return{shaders:a,fetch:function(b){if(a[b])return a[b].clone();
else throw J3D.Error.NO_BUILTIN_SHADER+b;}}};J3D.PERSPECTIVE=0;J3D.ORTHO=1;
J3D.Camera=function(a){that=this;a||(a={});if(!a.type)a.type=J3D.PERSPECTIVE;if(!a.near)a.near=1;if(!a.far)a.far=1E3;if(a.type==J3D.PERSPECTIVE){if(!a.fov)a.fov=45}else{if(a.left==null)a.left=0;if(a.right==null)a.right=1;if(a.top==null)a.top=0;if(a.bottom==null)a.bottom=1}this.near=a.near;this.far=a.far;this.fov=a.fov;this.onResize=function(){this.projectionMat=new SQR.ProjectionMatrix;if(a.type==J3D.PERSPECTIVE)this.aspect=gl.viewportWidth/gl.viewportHeight,this.projectionMat.perspective(a.fov,this.aspect,
a.near,a.far);else throw"Orthographic projection is not currently supported";};this.onResize()};J3D.Collider=function(){this.center=v3.ZERO()};J3D.Collider.SPHERE=1;J3D.Collider.BOX=2;J3D.Collider.MESH=3;J3D.Collider.Sphere=function(a,b){var c=new J3D.Collider;c.type=J3D.Collider.SPHERE;c.radius=a||0;c.center=b||v3.ZERO();return c};J3D.Collider.Box=function(a){var b=new J3D.Collider;b.type=J3D.Collider.BOX;b.box=a;return b};J3D.Collider.Mesh=function(a){var b=new J3D.Collider;b.type=J3D.Collider.MESH;a.boundingBox||a.calculateBoundingBox();b.box=a.boundingBox;b.mesh=a;return b};J3D.Cubemap=function(a,b){var c=this;this.tex=gl.createTexture();var d=6,e={};b||(b={});var g=function(){d--;if(d<=0&&(gl.bindTexture(gl.TEXTURE_CUBE_MAP,c.tex),gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,e.front),gl.texImage2D(gl.TEXTURE_CUBE_MAP_NEGATIVE_X,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,e.back),gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_Y,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,e.up),gl.texImage2D(gl.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,
e.down),gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_Z,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,e.right),gl.texImage2D(gl.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,e.left),gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_CUBE_MAP,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.generateMipmap(gl.TEXTURE_CUBE_MAP),
gl.bindTexture(gl.TEXTURE_CUBE_MAP,null),b.onLoad))b.onLoad()},h=function(a,b){typeof b=="string"?(e[a]=new Image,e[a].onload=g,e[a].src=b):b.getContext&&(e[a]=b,g())};h("left",a.left);h("right",a.right);h("up",a.up);h("down",a.down);h("back",a.back);h("front",a.front)};var gl;
J3D.Engine=function(a,b,c){var d=this,e=a?a:document.createElement("canvas"),g=!0;this.resolution=b&&b.resolution?b.resolution:1;a||(g=!1,document.body.appendChild(e));try{gl=e.getContext("experimental-webgl",c)}catch(h){throw J3D.Error.NO_WEBGL_CONTEXT;}if(typeof J3D.BuiltinShaders=="function")J3D.BuiltinShaders=J3D.BuiltinShaders();this.shaderAtlas=new J3D.ShaderAtlas;this.scene=new J3D.Scene;this.outCanvas=e;this.gl=gl;this.setClearColor=function(a){if(!c||!c.alpha)this.outCanvas.style["background-color"]=a.toRGB();
gl.clearColor(a.r,a.g,a.b,a.a)};this.clear=function(){gl.enable(gl.CULL_FACE);gl.frontFace(gl.CW);this.setClearColor(J3D.Color.black);this._opaqueMeshes=[];this._transparentMeshes=[];this._lights=[];this.scene.removeAll();this.shaderAtlas.clear()};this.destroy=function(){gl=null;g||(window.removeEventListener("resize",i),document.body.removeChild(e))};this.resize=function(a,b){if(gl&&gl!=void 0){var c=a?a:window.innerWidth,d=b?b:window.innerHeight;e.width=c/this.resolution;e.height=d/this.resolution;
e.style.width=c+"px";e.style.height=d+"px";gl.viewportWidth=e.width;gl.viewportHeight=e.height;gl.viewport(0,0,gl.viewportWidth,gl.viewportHeight);if(this.scene.camera)this.scene.camera.camera.onResize()}};var i=function(){d.resize()};g?this.resize(a.width,a.height):(this.resize(),window.addEventListener("resize",i));this.clear()};
J3D.Engine.prototype.render=function(a){J3D.Time.tick();a||gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);if(!this.scene.camera)throw J3D.Error.NO_CAMERA;this.scene.numChildren>0&&this.renderScene()};
J3D.Engine.prototype.renderScene=function(){var a,b;this._opaqueMeshes.length=0;this._transparentMeshes.length=0;for(a=this._lights.length=0;a<this.scene.numChildren;a++)this.updateTransform(this.scene.childAt(a),null);this.scene.camera.updateInverseMat();if(this.scene.skybox)gl.depthMask(!1),a=this.scene.camera.camera,b=this.scene.skybox,b.renderer.mid=a.near+(a.far-a.near)/2,this.renderObject(b),gl.depthMask(!0);b=this._lights.length;for(a=0;a<b;a++){var c=this._lights[a];c.updateWorldPosition()}gl.disable(gl.BLEND);
gl.enable(gl.DEPTH_TEST);b=this._opaqueMeshes.length;for(a=0;a<b;a++)this.renderObject(this._opaqueMeshes[a]);gl.enable(gl.BLEND);b=this._transparentMeshes.length;for(a=0;a<b;a++)c=this._transparentMeshes[a],gl.blendFunc(c.geometry.srcFactor!=null?c.geometry.srcFactor:gl.SRC_ALPHA,c.geometry.dstFactor!=null?c.geometry.dstFactor:gl.ONE),this.renderObject(c);gl.flush()};
J3D.Engine.prototype.renderObject=function(a){var b=this.shaderAtlas.getShader(a.renderer),c=this.scene.camera;gl.useProgram(b);b.uniforms.pMatrix&&gl.uniformMatrix4fv(b.uniforms.pMatrix.location,!1,c.camera.projectionMat.data);b.uniforms.vMatrix&&gl.uniformMatrix4fv(b.uniforms.vMatrix.location,!1,c.inverseMat.data);b.uniforms.mMatrix&&gl.uniformMatrix4fv(b.uniforms.mMatrix.location,!1,a.globalMatrix.data);b.uniforms.nMatrix&&gl.uniformMatrix3fv(b.uniforms.nMatrix.location,!1,a.normalMatrix.data);
b.uniforms.uEyePosition&&gl.uniform3fv(b.uniforms.uEyePosition.location,c.worldPosition.xyz());b.uniforms.uTileOffset&&gl.uniform4fv(b.uniforms.uTileOffset.location,a.getTileOffset());this._lights.length>0&&J3D.ShaderUtil.setLights(b,this._lights);J3D.ShaderUtil.setAttributes(b,a.geometry);a.renderer.setup(b,a);gl.cullFace(a.renderer.cullFace||gl.BACK);b=a.renderer.drawMode!=null?a.renderer.drawMode:gl.TRIANGLES;a.geometry.hasElements?(gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,a.geometry.elements.buffer),
gl.drawElements(b,a.geometry.elements.size,gl.UNSIGNED_SHORT,0)):gl.drawArrays(b,0,a.geometry.size)};J3D.Engine.prototype.updateTransform=function(a,b){a.updateWorld(b);for(var c=0;c<a.numChildren;c++)this.updateTransform(a.childAt(c),a);a.enabled&&(a.renderer&&a.geometry&&(a.geometry.renderMode==J3D.RENDER_AS_TRANSPARENT?this._transparentMeshes.push(a):this._opaqueMeshes.push(a)),a.light&&this._lights.push(a))};J3D.FrameBuffer=function(a,b){var c=this;this.width=a?a:gl.viewportWidth;this.height=b?b:gl.viewportHeight;this.fbo=gl.createFramebuffer();this.texture=gl.createTexture();this.depthBuffer=gl.createRenderbuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,this.fbo);gl.bindTexture(gl.TEXTURE_2D,this.texture);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,
gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,this.width,this.height,0,gl.RGBA,gl.UNSIGNED_BYTE,null);gl.bindRenderbuffer(gl.RENDERBUFFER,this.depthBuffer);gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,this.width,this.height);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.texture,0);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,this.depthBuffer);gl.bindTexture(gl.TEXTURE_2D,null);gl.bindRenderbuffer(gl.RENDERBUFFER,
null);gl.bindFramebuffer(gl.FRAMEBUFFER,null);this.resize=function(a,b){this.width=a?a:gl.viewportWidth;this.height=b?b:gl.viewportHeight;gl.bindTexture(gl.TEXTURE_2D,this.texture);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,this.width,this.height,0,gl.RGBA,gl.UNSIGNED_BYTE,null);gl.bindRenderbuffer(gl.RENDERBUFFER,this.depthBuffer);gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,this.width,this.height);gl.bindTexture(gl.TEXTURE_2D,null);gl.bindRenderbuffer(gl.RENDERBUFFER,null)};var d;a||window.addEventListener("resize",
function(){c.resize()})};J3D.FrameBuffer.prototype.bind=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,this.fbo)};J3D.FrameBuffer.prototype.unbind=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,null)};J3D.Geometry=function(){this.renderMode=J3D.RENDER_AS_OPAQUE;this.arrays=[];this.arraysByName={};this.elements=null;this.hasElements=!1;this.size=0};J3D.Geometry.prototype.setTransparency=function(a,b,c){a?(this.renderMode=J3D.RENDER_AS_TRANSPARENT,this.srcFactor=b,this.dstFactor=c):this.renderMode=J3D.RENDER_AS_OPAQUE};
J3D.Geometry.prototype.addArray=function(a,b,c,d,e){if(!d)d=gl.FLOAT;if(!e)e=gl.STATIC_DRAW;b=new J3D.Geometry.Attribute(a,b,c,d,e,gl.ARRAY_BUFFER);this.arrays.push(b);this.arraysByName[a]=b;this.size=b.size;return b};J3D.Geometry.prototype.replaceArray=function(a,b){a.data=b;gl.bindBuffer(gl.ARRAY_BUFFER,a.buffer);gl.bufferData(gl.ARRAY_BUFFER,b,a.usage)};
J3D.Geometry.prototype.addElement=function(a,b,c){if(!b)b=gl.UNSIGNED_SHORT;if(!c)c=gl.STATIC_DRAW;this.elements=new J3D.Geometry.Attribute("",a,0,b,c,gl.ELEMENT_ARRAY_BUFFER);this.hasElements=!0};J3D.Geometry.Attribute=function(a,b,c,d,e,g){this.name=a;this.data=b;this.usage=e;this.buffer=gl.createBuffer();gl.bindBuffer(g,this.buffer);gl.bufferData(g,b,e);this.size=c>0?b.length/c:b.length;this.itemSize=c;this.type=d};J3D.Light=function(a){this.type=a!=null?a:J3D.NONE;this.color=J3D.Color.white;this.intensity=1;this.angle=this.angleFalloff=0};J3D.NONE=-1;J3D.AMBIENT=0;J3D.DIRECT=1;J3D.POINT=2;J3D.SPOTLIGHT=3;J3D.HEMISPHERE=4;J3D.SPHERICAL_HARMONICS=5;J3D.Loader={};J3D.Loader.loadJSON=function(a,b){var c=new XMLHttpRequest;c.open("GET",a);c.onreadystatechange=function(){c.readyState==4&&b.call(null,JSON.parse(c.responseText))};c.send()};
J3D.Loader.parseJSONScene=function(a,b,c){var d=new J3D.Transform;d.light=new J3D.Light(J3D.AMBIENT);d.light.color=J3D.Loader.fromObject(J3D.Color,a.ambient);c.scene.add(d);for(var e in b)b[e]=new J3D.Mesh(b[e]);c.setClearColor(J3D.Loader.fromObject(J3D.Color,a.background));for(var g in a.textures)d=new J3D.Texture(a.path+a.textures[g].file),a.textures[g]=d;if(a.lightmaps){J3D.LightmapAtlas=[];for(e=0;e<a.lightmaps.length;e++)d=new J3D.Texture(a.path+a.lightmaps[e]),J3D.LightmapAtlas.push(d)}for(var h in a.materials){e=
a.materials[h];e=J3D.Loader.fetchShader(e.type,e);e.color=J3D.Loader.fromObject(J3D.Color,e.color);if(e.emissive)e.emissive=J3D.Loader.fromObject(J3D.Color,e.emissive);if(e.textureTile)e.textureTile=J3D.Loader.v2FromArray(e.textureTile);if(e.textureOffset)e.textureOffset=J3D.Loader.v2FromArray(e.textureOffset);if(e.colorTexture)e.colorTexture=a.textures[e.colorTexture],e.hasColorTexture=!0;a.materials[h]=e}for(var i in a.lights)e=a.lights[i],e=J3D.Loader.fromObject(J3D.Light,e),e.color=J3D.Loader.fromObject(J3D.Color,
e.color),a.lights[i]=e;for(var j in a.cameras)e=a.cameras[j],e=new J3D.Camera({fov:e.fov,near:e.near,far:e.far}),a.cameras[j]=e;i=function(a){var c=a.collider;switch(c.type){case "box":var d=J3D.Loader.v3FromArray(c.size),e=J3D.Loader.v3FromArray(c.center);a.collider=J3D.Collider.Box({minX:e.x+d.x*-0.5,maxX:e.x+d.x*0.5,minY:e.y+d.y*-0.5,maxY:e.y+d.y*0.5,minZ:e.z+d.z*-0.5,maxZ:e.z+d.z*0.5});break;case "sphere":e=J3D.Loader.v3FromArray(c.center);a.collider=J3D.Collider.Sphere(c.radius,e);break;case "mesh":a.collider=
J3D.Collider.Mesh(b[c.mesh])}};for(e=0;e<a.transforms.length;e++){j=a.transforms[e];j=J3D.Loader.fromObject(J3D.Transform,j);j.position=J3D.Loader.v3FromArray(j.position);j.rotation=J3D.Loader.v3FromArray(j.rotation);if(j.scale instanceof Array)j.scale=J3D.Loader.v3FromArray(j.scale);if(j.renderer)j.renderer=a.materials[j.renderer];if(j.mesh)j.geometry=b[j.mesh];if(j.light)j.light=a.lights[j.light];j.collider&&i(j);if(j.camera)j.camera=a.cameras[j.camera],c.scene.setCamera(j);a.transforms[e]=j}i=
function(b){for(var c=0;c<a.transforms.length;c++)if(a.transforms[c].uid==b)return a.transforms[c]};for(e=0;e<a.transforms.length;e++)j=a.transforms[e],j.parent!=null?(j.parent=i(j.parent),j.parent.add(j)):c.scene.add(j)};J3D.Loader.fetchShader=function(a,b){var c=J3D.BuiltinShaders.fetch(a),d;for(d in b)c[d]=b[d];return c};J3D.Loader.fromObject=function(a,b){var c=new a,d;for(d in b)c[d]=b[d];return c};J3D.Loader.v2FromArray=function(a){return new v2(a[0],a[1])};
J3D.Loader.v3FromArray=function(a){return new v3(a[0],a[1],a[2])};J3D.Loader.loadGLSL=function(a,b){var c=new XMLHttpRequest;c.open("GET",a);c.onreadystatechange=function(){c.readyState==4&&b.call(null,J3D.ShaderUtil.parseGLSL(c.responseText))};c.send()};J3D.Mesh=function(a){that=this;J3D.Geometry.call(this);this.hasUV1=!1;this.calculateBoundingBox=function(){for(var b=a.vertices,d={minX:Number.MAX_VALUE,maxX:-Number.MIN_VALUE,minY:Number.MAX_VALUE,maxY:-Number.MIN_VALUE,minZ:Number.MAX_VALUE,maxZ:-Number.MIN_VALUE},e=0;e<b.length;e+=3)d.minX=Math.min(d.minX,b[e+0]),d.maxX=Math.max(d.maxX,b[e+0]),d.minY=Math.min(d.minY,b[e+1]),d.maxY=Math.max(d.maxY,b[e+1]),d.minZ=Math.min(d.minZ,b[e+2]),d.maxZ=Math.max(d.maxZ,b[e+2]);this.boundingBox=d};for(var b in a)switch(b){case "vertices":this.vertexPositionBuffer=
this.addArray(J3D.Mesh.VERTEX_POSITION,new Float32Array(a[b]),3,gl.DYNAMIC_DRAW);break;case "colors":a[b].length>0&&this.addArray("aVertexColor",new Float32Array(a[b]),4);break;case "normals":this.vertexNormalBuffer=a[b].length>0?this.addArray("aVertexNormal",new Float32Array(a[b]),3):this.addArray("aVertexNormal",new Float32Array(this.size*3),3);break;case "uv1":this.textureCoordBuffer=a[b].length>0?this.addArray("aTextureCoord",new Float32Array(a[b]),2):this.addArray("aTextureCoord",new Float32Array(this.size*
2),2);this.hasUV1=!0;break;case "uv2":a[b].length>0&&this.addArray("aTextureCoord2",new Float32Array(a[b]),2);break;case "tris":a[b].length>0&&this.addElement(new Uint16Array(a[b]));break;case "tangents":a[b].length>0&&this.addArray("aVertexTangent",new Float32Array(a[b]),4);break;default:console.log("WARNING! Unknown attribute in geometry: "+b+". It will be ignored.")}this.flip=function(){var a=[],b=[],e=this.vertexPositionBuffer.data,g=this.vertexNormalBuffer.data,h;for(h=0;h<e.length;h+=3)a.push(e[h],
e[h+2],e[h+1]),b.push(g[h],g[h+1],g[h+2]);this.replaceArray(this.vertexPositionBuffer,new Float32Array(a));this.replaceArray(this.vertexNormalBuffer,new Float32Array(b));return this}};J3D.Mesh.prototype=new J3D.Geometry;J3D.Mesh.prototype.constructor=J3D.Mesh;J3D.Mesh.prototype.supr=J3D.Geometry.prototype;J3D.Mesh.VERTEX_POSITION="aVertexPosition";J3D.Postprocess=function(a){this.drawMode=gl.TRIANGLES;this.engine=a;this.fbo=new J3D.FrameBuffer;this.geometry=J3D.Primitive.FullScreenQuad();this.filter=null};J3D.Postprocess.prototype.render=function(){this.fbo.bind();this.engine.render();this.fbo.unbind();this.renderEffect(this.fbo.texture)};
J3D.Postprocess.prototype.renderEffect=function(a){this.program=this.engine.shaderAtlas.getShader(this.filter);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);gl.useProgram(this.program);J3D.ShaderUtil.setAttributes(this.program,this.geometry);this.filter.uTexture=a;this.filter.setup(this.program);this.geometry.renderMode==J3D.RENDER_AS_OPAQUE?(gl.disable(gl.BLEND),gl.enable(gl.DEPTH_TEST)):(gl.disable(gl.DEPTH_TEST),gl.enable(gl.BLEND),gl.blendFunc(this.geometry.srcFactor!=null?this.geometry.srcFactor:
gl.SRC_ALPHA,this.geometry.dstFactor!=null?this.geometry.dstFactor:gl.ONE));gl.drawArrays(this.drawMode,0,this.geometry.size)};J3D.Primitive={};
J3D.Primitive.Cube=function(a,b,c,d){var e=J3D.Primitive.getEmpty();a*=0.5;b*=0.5;c*=0.5;var g=[0,1,0,1],h=[];h[0]=d?[0,0.5,0,1/3]:g;h[1]=d?[0.5,1,0,1/3]:g;h[2]=d?[0,0.5,1/3,2/3]:g;h[3]=d?[0.5,1,1/3,2/3]:g;h[4]=d?[0,0.5,2/3,1]:g;h[5]=d?[0.5,1,2/3,1]:g;J3D.Primitive.addQuad(e,new v3(-a,b,c),new v3(a,b,c),new v3(a,-b,c),new v3(-a,-b,c),h[0]);J3D.Primitive.addQuad(e,new v3(a,b,-c),new v3(-a,b,-c),new v3(-a,-b,-c),new v3(a,-b,-c),h[1]);J3D.Primitive.addQuad(e,new v3(-a,b,-c),new v3(-a,b,c),new v3(-a,
-b,c),new v3(-a,-b,-c),h[2]);J3D.Primitive.addQuad(e,new v3(a,b,c),new v3(a,b,-c),new v3(a,-b,-c),new v3(a,-b,c),h[3]);J3D.Primitive.addQuad(e,new v3(a,b,c),new v3(-a,b,c),new v3(-a,b,-c),new v3(a,b,-c),h[4]);J3D.Primitive.addQuad(e,new v3(a,-b,c),new v3(a,-b,-c),new v3(-a,-b,-c),new v3(-a,-b,c),h[5]);return new J3D.Mesh(e)};
J3D.Primitive.FullScreenQuad=function(){var a=new J3D.Geometry;a.addArray("aVertexPosition",new Float32Array([-1,1,1,1,1,-1,-1,1,1,-1,-1,-1]),2);a.addArray("aTextureCoord",new Float32Array([0,1,1,1,1,0,0,1,1,0,0,0]),2);return a};
J3D.Primitive.Plane=function(a,b,c,d,e,g,h){var i=J3D.Primitive.getEmpty();e||(e=0);g||(g=0);a*=0.5;b*=0.5;c||(c=1);d||(d=1);e=-a+e;g=b+g;var j=h&&h.us?h.us:0,q=h&&h.ue?h.ue:1,m=h&&h.vs?h.vs:0;h=h&&h.ve?h.ve:1;a=a*2/c;b=b*2/d;for(var p=0;p<c;p++)for(var n=0;n<d;n++){var o=e+p*a,k=o+a,r=g-n*b,t=r-b,u=new v3(o,r,0);r=new v3(k,r,0);k=new v3(k,t,0);o=new v3(o,t,0);J3D.Primitive.addQuad(i,u,r,k,o,[j+1/c*p*(q-j),j+1/c*(p+1)*(q-j),1-(m+1/d*(n+1)*(h-m)),1-(m+1/d*n*(h-m))])}return new J3D.Mesh(i)};
J3D.Primitive.Sphere=function(a,b,c){var d=J3D.Primitive.getEmpty(),e=[],g=[];a=a||50;b=Math.max(3,Math.floor(b)||8);c=Math.max(3,Math.floor(c)||6);var h=Math.PI*2,i=Math.PI,j,q;for(q=0;q<=c;q++)for(j=0;j<=b;j++){var m=j/b,p=q/c;e.push(new v3(-a*Math.cos(0+m*h)*Math.sin(0+p*i),a*Math.cos(0+p*i),a*Math.sin(0+m*h)*Math.sin(0+p*i)));g.push([m,1-p])}for(q=0;q<c;q++)for(j=0;j<b;j++){var n=b+1;a=e[q*n+j+0];h=e[q*n+j+1];i=e[(q+1)*n+j+1];m=e[(q+1)*n+j+0];p=g[q*n+j+0];var o=g[q*n+j+1],k=g[(q+1)*n+j+1];n=g[(q+
1)*n+j+0];var r=a.cp().norm(),t=h.cp().norm(),u=i.cp().norm(),v=m.cp().norm(),f=Math.floor(d.vertices.length/3);d.vertices.push(a.x,a.y,a.z,h.x,h.y,h.z,i.x,i.y,i.z,m.x,m.y,m.z);d.uv1.push(p[0],p[1],o[0],o[1],k[0],k[1],n[0],n[1]);d.normals.push(r.x,r.y,r.z,t.x,t.y,t.z,u.x,u.y,u.z,v.x,v.y,v.z);d.tris.push(f+0,f+1,f+2,f+0,f+2,f+3)}J3D.MathUtil.calculateTangents(d);return new J3D.Mesh(d)};
J3D.Primitive.SingleTextureSkybox=function(a,b){var c=J3D.Primitive.getEmpty(),d=[],e=[],g=g||50,h=Math.max(3,Math.floor(a)||8),i=Math.max(3,Math.floor(b)||6),j=Math.PI*2,q=Math.PI,m,p;for(p=0;p<=i;p++)for(m=0;m<=h;m++){var n=m/h,o=p/i,k=new v3(Math.cos(0+n*j)*Math.sin(0+o*q)*-1,Math.cos(0+o*q),Math.sin(0+n*j)*Math.sin(0+o*q)),r=Math.max(Math.max(k.x,k.y),k.z),t=Math.min(Math.min(k.x,k.y),k.z);Math.abs(t)>r?(r=t,t=-g):t=g;if(r==k.x)r=t/k.x,k.x=k.x*t/k.x,k.y*=r,k.z*=r;else if(r==k.y)r=t/k.y,k.y=t,
k.x*=r,k.z*=r;else if(r==k.z)r=t/k.z,k.z=t,k.x*=r,k.y*=r;d.push(k);e.push([n,o])}for(p=0;p<=i;p++)for(m=0;m<h;m++){g=d[p*h+m+0];j=d[p*h+m+1];q=d[(p+1)*h+m+1];n=d[(p+1)*h+m+0];o=e[p*h+m+0];k=e[p*h+m+1];r=e[(p+1)*h+m+1];t=e[(p+1)*h+m+0];var u=c.vertices.length/3;c.vertices.push(g.x,g.y,g.z,j.x,j.y,j.z,q.x,q.y,q.z,n.x,n.y,n.z);c.uv1.push(o[0],o[1],k[0],k[1],r[0],r[1],t[0],t[1]);c.tris.push(u+0,u+2,u+1,u+0,u+3,u+2)}return new J3D.Mesh(c)};
J3D.Primitive.getEmpty=function(){var a={};a.vertices=[];a.normals=[];a.uv1=[];a.tangents=[];a.tris=[];return a};J3D.Primitive.addQuad=function(a,b,c,d,e,g){var h=v3.cross(b.sub(c),c.sub(d)).norm(),i=a.vertices.length/3;if(!g||!g.length||g.length!=4)g=[0,1,0,1];a.vertices.push(b.x,b.y,b.z,c.x,c.y,c.z,d.x,d.y,d.z,e.x,e.y,e.z);a.normals.push(h.x,h.y,h.z,h.x,h.y,h.z,h.x,h.y,h.z,h.x,h.y,h.z);a.uv1.push(g[0],g[3],g[1],g[3],g[1],g[2],g[0],g[2]);a.tris.push(i,i+1,i+2,i,i+2,i+3)};J3D.Ray=function(a,b){this.origin=a||new v3;this.direction=b||new v3;this.localOrigin=new v3;this.localDirection=new v3};
J3D.Ray.fromMousePosition=function(a,b,c,d){if(!J3D.Ray._mt)J3D.Ray._mt=new SQR.Matrix44;if(!J3D.Ray._nt)J3D.Ray._nt=new SQR.Matrix33;d||(d={x:0,y:0,width:window.innerWidth,height:window.innerHeight});a=[(a-d.x)/d.width*2-1,(1-(b-d.y)/d.height)*2-1,0];c.camera.projectionMat.inverse(J3D.Ray._mt);J3D.Ray._mt.transformVector(a);c.globalMatrix.transformVector(a);b=new J3D.Ray;b.origin.fromArray(a);b.direction=b.origin.sub(c.worldPosition).norm();return b};
J3D.Ray.prototype.makeLocal=function(a){if(!J3D.Ray._mt)J3D.Ray._mt=new SQR.Matrix44;if(!J3D.Ray._nt)J3D.Ray._nt=new SQR.Matrix33;this.origin.cp(this.localOrigin);a.globalMatrix.inverse(J3D.Ray._mt);J3D.Ray._mt.transformVector(this.localOrigin);this.direction.cp(this.localDirection);a.normalMatrix.inverse(J3D.Ray._nt);J3D.Ray._nt.transformVector(this.localDirection)};J3D.Scene=function(){var a=[];this.numChildren=0;this.add=function(){for(var b,c=0;c<arguments.length;c++){var d=arguments[c];b||(b=d);a.indexOf(d)==-1&&a.push(d);d.parent=null;this.numChildren=a.length}return b};this.recurse=function(b){for(var c=0;c<a.length;c++)a[c].recurse(b)};this.childAt=function(b){return a[b]};this.contains=function(b){return a.indexOf(b)>-1};this.remove=function(b,c){if(this.contains(b))return a.splice(a.indexOf(b),1),this.numChildren=a.length,!0;else if(c)for(var d=0;d<
a.length;d++){if(a[d].remove(b))return!0}else return!1};this.removeAll=function(){a=[];this.numChildren=0;this.skybox=this.camera=null};this.addSkybox=function(a){this.skybox=new J3D.Transform;this.skybox.renderer=new J3D.BuiltinShaders.fetch("Skybox");this.skybox.renderer.uCubemap=a;this.skybox.geometry=J3D.Primitive.Cube(1,1,1).flip()};this.setCamera=function(a){this.camera=a};this.find=function(a){a=a.split("/");for(var c=0;c<this.numChildren;c++)if(this.childAt(c).name==a[0])return a.length==
1?this.childAt(c):this.childAt(c).find(a.slice(1).join("/"));return null}};J3D.Shader=function(a,b,c,d){if(!a)throw Error("You must specify a name for custom shaders");if(b==null||c==null)throw Error("You must pass a vertex and fragment shader source for custom shaders");this.name=a;this.drawMode=4;this._vertSource=b;this._fragSource=c;this.reloadStaticUniforms=!0;this.su={};this.loadedStaticTextures={};this.metaData=d||{};this.cloneCount=0};J3D.Shader.prototype.vertSource=function(){return this._vertSource};J3D.Shader.prototype.fragSource=function(){return this._fragSource};
J3D.Shader.prototype.setup=function(a){if(this.reloadStaticUniforms)this.loadedStaticTextures={};this.uTime=J3D.Time.time;var b=0,c;for(c in a.uniforms)this.reloadStaticUniforms&&this.su[c]!=null&&this[c]==null&&this.su[c].loaded==null&&J3D.ShaderUtil.setUniform(c,a,this.su),this.su[c]!=null&&this[c]==null&&this.su[c].loaded&&!this.loadedStaticTextures[c]&&(J3D.ShaderUtil.setUniform(c,a,this.su),this.loadedStaticTextures[c]=!0),this[c]!=null&&(b++,J3D.ShaderUtil.setUniform(c,a,this));this.reloadStaticUniforms=
!1};J3D.Shader.prototype.clone=function(){this.cloneCount++;var a=new J3D.Shader(this.name,this._vertSource,this._fragSource);for(s in this)typeof this[s]!=="function"&&this.hasOwnProperty(s)&&s!="name"&&(a[s]=this[s]);if(this.hasOwnProperty("setup"))a.setup=this.setup;a.su={};for(ss in this.su)typeof this.su[ss]!=="function"&&this.su.hasOwnProperty(ss)&&(a.su[ss]=this.su[ss]);a.reloadStaticUniforms=!0;return a};J3D.ShaderAtlas=function(){this.clear()};
J3D.ShaderAtlas.prototype.compileShaderSource=function(a,b,c,d){var e="";if(d.includes&&d.includes.length>0)for(var g=0;g<d.includes.length;g++)e+=J3D.ShaderSource[d.includes[g]];e+=d.common||"";if(c==gl.VERTEX_SHADER){var h="";if(d.vertexIncludes&&d.vertexIncludes.length>0)for(g=0;g<d.vertexIncludes.length;g++)h+=J3D.ShaderSource[d.vertexIncludes[g]]}else if(h="",d.fragmentIncludes&&d.fragmentIncludes.length>0)for(g=0;g<d.fragmentIncludes.length;g++)h+=J3D.ShaderSource[d.fragmentIncludes[g]];b=e+
h+b;c=gl.createShader(c);gl.shaderSource(c,b);gl.compileShader(c);if(!gl.getShaderParameter(c,gl.COMPILE_STATUS))throw J3D.Error.SHADER_COMPILE_ERROR+gl.getShaderInfoLog(c);this.programs[a]=c};
J3D.ShaderAtlas.prototype.linkShader=function(a){a=a.name;var b=this.programs[a+"Vert"],c=this.programs[a+"Frag"],d=gl.createProgram();gl.attachShader(d,b);gl.attachShader(d,c);gl.linkProgram(d);gl.getProgramParameter(d,gl.LINK_STATUS)||console.log("Error linking program "+a);gl.useProgram(d);c=0;d.uniforms={};var e=gl.getProgramParameter(d,gl.ACTIVE_UNIFORMS);for(b=0;b<e;b++){var g=gl.getActiveUniform(d,b);d.uniforms[g.name]=g;d.uniforms[g.name].location=gl.getUniformLocation(d,g.name);if(J3D.ShaderUtil.isTexture(g.type))d.uniforms[g.name].texid=
c,c++}d.attributes={};c=gl.getProgramParameter(d,gl.ACTIVE_ATTRIBUTES);for(b=0;b<c;b++)e=gl.getActiveAttrib(d,b),d.attributes[e.name]=gl.getAttribLocation(d,e.name),gl.enableVertexAttribArray(d.attributes[e.name]);this.shaderCount++;this.shaders[a]=d};
J3D.ShaderAtlas.prototype.getShader=function(a){this.shaders[a.name]||(this.compileShaderSource(a.name+"Vert",a.vertSource(),gl.VERTEX_SHADER,a.metaData),this.compileShaderSource(a.name+"Frag",a.fragSource(),gl.FRAGMENT_SHADER,a.metaData),this.linkShader(a));return this.shaders[a.name]};J3D.ShaderAtlas.prototype.clear=function(){this.shaders={};this.programs={};this.shaderCount=0};J3D.ShaderSource={};J3D.ShaderSource.CopyFilter="//#name CopyFilter\n//#description All this shader does is to render a texture (typically a render texture) pixel-to-pixel.\n//#description It is useful in effects like Persistence\n//#author bartekd\n//#include CommonFilterInclude\n//#vertex\n//#include BasicFilterVertex\n//#fragment\nuniform sampler2D uTexture;\nvarying vec2 vTextureCoord;\nvoid main(void) {\nvec4 p = texture2D(uTexture, vTextureCoord);\ngl_FragColor = vec4(p.rgb, 1.0);\n}\n";
J3D.ShaderSource.Depth="//#name Depth\n//#author bartekd\n//#include CommonInclude\n//#vertex\n//#include VertexInclude\nvarying float depth;\nvoid main(void) {\nvec4 p = mMatrix * vec4(aVertexPosition, 1.0);\ngl_Position = pMatrix * vMatrix * p;\ndepth = gl_Position.z/gl_Position.w;\n}\n//#fragment\nvarying float depth;\nvoid main(void) {\nfloat d = 1.0 - depth;\ngl_FragColor = vec4(d, d, d, 1.0);\n}\n";J3D.ShaderSource.Gouraud="//#name Gouraud\n//#author bartekd\n//#include CommonInclude\n//#vertex\n//#include VertexInclude\n//#include Lights\nuniform float specularIntensity;\nuniform float shininess;\nvarying vec3 vLight;\nvarying vec2 vTextureCoord;\nvoid main(void) {\nvec4 p = mMatrix * vec4(aVertexPosition, 1.0);\ngl_Position = pMatrix * vMatrix * p;\nvTextureCoord = getTextureCoord(aTextureCoord);\nvec3 n = normalize( nMatrix * aVertexNormal );\nvLight = computeLights(p, n, specularIntensity, shininess);\n}\n//#fragment\nuniform vec4 color;\nuniform vec4 emissive;\nuniform sampler2D colorTexture;\nuniform bool hasColorTexture;\nvarying vec3 vLight;\nvarying vec2 vTextureCoord;\nvoid main(void) {\nvec4 tc = color;\nif(hasColorTexture) tc *= texture2D(colorTexture, vTextureCoord);\ngl_FragColor = vec4(tc.rgb * vLight + emissive.rgb, tc.a);\n}\n";
J3D.ShaderSource.Lightmap="//#name Lightmap\n//#author bartekd\n//#include CommonInclude\nvarying vec2 vTextureCoord;\nvarying vec2 vTextureCoord2;\nvarying vec4 vPosition;\nvarying vec3 vNormal;\n//#vertex\n//#include VertexInclude\nuniform vec4 lightmapAtlas;\nvoid main(void) {\nvTextureCoord = getTextureCoord(aTextureCoord);\nvTextureCoord2 = aTextureCoord2 * lightmapAtlas.xy + lightmapAtlas.zw;\nvNormal = nMatrix * aVertexNormal;\nvPosition = mMatrix * vec4(aVertexPosition, 1.0);\ngl_Position = pMatrix * vMatrix * vPosition;\ngl_PointSize = 5.0;\n}\n//#fragment\n//#include Lights\nuniform vec4 color;\nuniform sampler2D colorTexture;\nuniform sampler2D lightmapTexture;\nuniform float specularIntensity;\nuniform float shininess;\nvoid main(void) {\nvec4 tc = texture2D(colorTexture, vTextureCoord);\nvec4 lm = texture2D(lightmapTexture, vTextureCoord2);\nfloat si = specularIntensity * tc.r;\nvec3 ltc = computeLights(vPosition, vNormal, si, shininess);\nvec3 lmc = lm.rgb * lm.a;\nif(tc.a < 0.1) discard;\nelse gl_FragColor = vec4(color.rgb * tc.rgb * (ltc + lmc), 1.0);\n}\n";
J3D.ShaderSource.Normal2Color="//#name Normal2Color\n//#description Simplest shader possible, no includes\n//#author bartekd\nprecision mediump float;\nvarying vec3 vColor;\n//#vertex\nattribute vec3 aVertexPosition;\nattribute vec3 aVertexNormal;\nuniform mat4 mMatrix;\nuniform mat4 vMatrix;\nuniform mat4 pMatrix;\nvoid main(void) {\ngl_Position = pMatrix * vMatrix * mMatrix * vec4(aVertexPosition, 1.0);\nvColor = normalize( aVertexNormal / 2.0 + vec3(0.5) );\n}\n//#fragment\nvoid main(void) {\ngl_FragColor = vec4(vColor, 1.0);\n}\n";
J3D.ShaderSource.Phong="//#name Phong\n//#description Classic phong shader\n//#author bartekd\n//#include CommonInclude\n//#vertex\n//#include VertexInclude\nvarying vec4 vPosition;\nvarying vec2 vTextureCoord;\nvarying vec3 vNormal;\nvoid main(void) {\nvTextureCoord = getTextureCoord(aTextureCoord);\nvNormal = nMatrix * aVertexNormal;\nvPosition = mMatrix * vec4(aVertexPosition, 1.0);\ngl_Position = pMatrix * vMatrix * vPosition;\ngl_PointSize = 5.0;\n}\n//#fragment\n//#include Lights\nuniform vec4 color;\nuniform sampler2D colorTexture;\nuniform bool hasColorTexture;\nuniform float specularIntensity;\nuniform float shininess;\nvarying vec4 vPosition;\nvarying vec3 vLight;\nvarying vec2 vTextureCoord;\nvarying vec3 vNormal;\nvoid main(void) {\nvec4 tc = color;\nif(hasColorTexture) tc *= texture2D(colorTexture, vTextureCoord);\nvec3 l = computeLights(vPosition, vNormal, specularIntensity, shininess);\ngl_FragColor = vec4(tc.rgb * l, tc.a);\n}\n";
J3D.ShaderSource.Reflective="//#name Reflective\n//#description Based on Cg tutorial: http://http.developer.nvidia.com/CgTutorial/cg_tutorial_chapter07.html\n//#author bartekd\n//#include CommonInclude\nvarying vec3 refVec;\n//#vertex\n//#include VertexInclude\nvoid main(void) {\ngl_Position = mvpMatrix() * vec4(aVertexPosition, 1.0);\nvec3 normal = normalize(nMatrix * aVertexNormal);\nvec3 incident = normalize( (mMatrix * vec4(aVertexPosition, 1.0)).xyz - uEyePosition);\nrefVec = reflect(incident, normal);\n}\n//#fragment\nuniform samplerCube uCubemap;\nvoid main(void) {\ngl_FragColor = textureCube(uCubemap, refVec);\n}\n";
J3D.ShaderSource.Selflit="//#name Selflit\n//#author bartekd\n//#description A very basic shader that uses a color and/or a texture and no lights\n//#include CommonInclude\n//#vertex\n//#include VertexInclude\nvarying vec2 vTextureCoord;\nvoid main(void) {\ngl_Position = pMatrix * vMatrix * mMatrix * vec4(aVertexPosition, 1.0);\ngl_PointSize = 1.0;\nvTextureCoord = getTextureCoord(aTextureCoord);\n}\n//#fragment\nuniform vec4 color;\nuniform sampler2D colorTexture;\nuniform bool hasColorTexture;\nvarying vec2 vTextureCoord;\nvoid main(void) {\nvec4 tc = color;\nif(hasColorTexture) tc *= texture2D(colorTexture, vTextureCoord);\ngl_FragColor = vec4(tc.rgba);\n}\n";
J3D.ShaderSource.Skybox="//#name Skybox\n//#author bartekd\n//#include CommonInclude\n//#vertex\n//#include VertexInclude\nuniform float mid;\nvarying vec3 vVertexPosition;\nvoid main(void) {\ngl_Position = pMatrix * vMatrix * vec4(uEyePosition + aVertexPosition * mid, 1.0);\nvVertexPosition = aVertexPosition;\n}\n//#fragment\nuniform samplerCube uCubemap;\nvarying vec3 vVertexPosition;\nvoid main(void) {\ngl_FragColor = textureCube(uCubemap, vVertexPosition);\n}\n";J3D.ShaderSource.Vignette="//#name Vignette\n//#author bartekd\n//#vertex\n//#include BasicFilterVertex\n//#fragment\n//#include CommonFilterInclude\nuniform sampler2D uTexture;\nvarying vec2 vTextureCoord;\nvoid main(void) {\nvec2 m = vec2(0.5, 0.5);\nfloat d = distance(m, vTextureCoord) * 1.0;\nvec3 c = texture2D(uTexture, vTextureCoord).rgb * (1.0 - d * d);\ngl_FragColor = vec4(c.rgb, 1.0);\n}\n";
J3D.ShaderSource.BasicFilterVertex="//#name BasicFilterVertex\n//#description A basic vertex shader for filters that use a full screen quad and have all the logic in fragment shader\nattribute vec2 aVertexPosition;\nattribute vec2 aTextureCoord;\nvarying vec2 vTextureCoord;\nvoid main(void) {\ngl_Position = vec4(aVertexPosition, 0.0, 1.0);\nvTextureCoord = aTextureCoord;\n}\n";J3D.ShaderSource.CommonFilterInclude="//#name CommonFilterInclude\n//#description Common uniforms and function for filters\nprecision mediump float;\nuniform float uTime;\nfloat whiteNoise(vec2 uv, float scale) {\nfloat x = (uv.x + 0.2) * (uv.y + 0.2) * (10000.0 + uTime);\nx = mod( x, 13.0 ) * mod( x, 123.0 );\nfloat dx = mod( x, 0.005 );\nreturn clamp( 0.1 + dx * 100.0, 0.0, 1.0 ) * scale;\n}\nfloat brightness(vec3 c) {\nreturn c.r * 0.2126 + c.g * 0.7152 + c.b * 0.0722;\n}\n";
J3D.ShaderSource.CommonInclude="//#name CommonInclude\n//#description Collection of common uniforms, functions and structs to include in shaders (both fragment and vertex)\nprecision mediump float;\nuniform float uTime;\nuniform mat4 mMatrix;\nuniform mat4 vMatrix;\nuniform mat3 nMatrix;\nuniform mat4 pMatrix;\nuniform vec3 uEyePosition;\nuniform vec4 uTileOffset;\nmat4 mvpMatrix() {\nreturn pMatrix * vMatrix * mMatrix;\n}\nmat4 mvMatrix() {\nreturn vMatrix * mMatrix;\n}\nfloat luminance(vec3 c) {\nreturn c.r * 0.299 + c.g * 0.587 + c.b * 0.114;\n}\nfloat brightness(vec3 c) {\nreturn c.r * 0.2126 + c.g * 0.7152 + c.b * 0.0722;\n}\nvec2 getTextureCoord(vec2 uv) {\nreturn uv * uTileOffset.xy + uTileOffset.zw;\n}\n";
J3D.ShaderSource.Lights="//#name Lights\n//#description Collection of light equations\n//#description Requires CommonInclude\n//#description TODO Separate functions for directional, spot, point, hemi/phong models for all, separate dif func from spec\nstruct lightSource {\nint type;\nvec3 direction;     // used by directional and spotlight (global direction of the transfom)\nvec3 position;      // used by hemisphere, point, spotlight (it's the global position of the transform)\nvec3 color;         // used by d/p/s and hemisphere\nfloat intensity;    // used by spherical harmonics & d/p/s\nfloat angleFalloff; // used by hemisphere and spotlight (TODO: change to falloff)\nfloat angle;        // used by spotlight\n};\nuniform lightSource uLight[4];\nconst float C1 = 0.429043;\nconst float C2 = 0.511664;\nconst float C3 = 0.743125;\nconst float C4 = 0.886227;\nconst float C5 = 0.247708;\n//const vec3 L00  = vec3( 0.871297,  0.875222,  0.864470);\n//const vec3 L1m1 = vec3( 0.175058,  0.245335,  0.312891);\n//const vec3 L10  = vec3( 0.034675,  0.036107,  0.037362);\n//const vec3 L11  = vec3(-0.004629, -0.029448, -0.048028);\n//const vec3 L2m2 = vec3(-0.120535, -0.121160, -0.117507);\n//const vec3 L2m1 = vec3( 0.003242,  0.003624,  0.007511);\n//const vec3 L20  = vec3(-0.028667, -0.024926, -0.020998);\n//const vec3 L21  = vec3(-0.077539, -0.086325, -0.091591);\n//const vec3 L22  = vec3(-0.161784, -0.191783, -0.219152);\nconst vec3 L00  = vec3( 0.078908,  0.043710,  0.054161);\nconst vec3 L1m1 = vec3( 0.039499,  0.034989,  0.060488);\nconst vec3 L10  = vec3(-0.033974, -0.018236, -0.026940);\nconst vec3 L11  = vec3(-0.029213, -0.005562,  0.000944);\nconst vec3 L2m2 = vec3(-0.011141, -0.005090, -0.012231);\nconst vec3 L2m1 = vec3(-0.026240, -0.022401, -0.047479);\nconst vec3 L20  = vec3(-0.015570, -0.009471, -0.014733);\nconst vec3 L21  = vec3( 0.056014,  0.021444,  0.013915);\nconst vec3 L22  = vec3( 0.021205, -0.005432, -0.030374);\nvec3 sphericalHarmonics(vec3 n, lightSource ls) {\nvec3 c =  C1 * L22 * (n.x * n.x - n.y * n.y) +\nC3 * L20 * n.z * n.z +\nC4 * L00 -\nC5 * L20 +\n2.0 * C1 * L2m2 * n.x * n.y +\n2.0 * C1 * L21  * n.x * n.z +\n2.0 * C1 * L2m1 * n.y * n.z +\n2.0 * C2 * L11  * n.x +\n2.0 * C2 * L1m1 * n.y +\n2.0 * C2 * L10  * n.z;\nc *= ls.intensity;\nreturn c;\n}\nvec3 hemisphere(vec4 p, vec3 n, float si, float sh, lightSource ls) {\nvec3 lv = normalize(ls.position - p.xyz);\nfloat dif = (dot(n, lv) * 0.5 + 0.5);\ndif = smoothstep(ls.angleFalloff, 1.0-ls.angleFalloff, dif);\nfloat spec = 0.0;\nif(si > 0.0) {\nvec3 eyed = normalize(uEyePosition - p.xyz);\nvec3 refd = reflect(-lv, n);\nspec = pow(max(dot(refd, eyed), 0.0), sh) * si;\n};\nreturn ls.color * dif + ls.color * spec;\n}\nvec3 phong(vec4 p, vec3 n, float si, float sh, lightSource ls){\nvec3 ld;\nif(ls.type == 1) ld = -ls.direction;\nelse ld = normalize(ls.position - p.xyz);\nfloat dif = max(dot(n, ld), 0.0);\nfloat spec = 0.0;\nif(si > 0.0) {\nvec3 eyed = normalize(uEyePosition - p.xyz);\nvec3 refd = reflect(-ld, n);\nspec = pow( (dot(refd, eyed) + 1.0) * 0.5, sh * 4.0) * si;\n}\nif(ls.type == 3) {\nfloat dd = dot(ld, -ls.direction);\nfloat ca = cos(ls.angle);\nfloat cf = cos(ls.angle + ls.angleFalloff);\nfloat spm = smoothstep(cf, ca, dd);\ndif *= spm;\nspec *= spm;\n}\ndif *= ls.intensity;\n//spec *= ls.intensity;\nreturn ls.color * dif + ls.color * spec;\n}\nvec3 singleLight(vec4 p, vec3 n, float si, float sh, lightSource ls) {\nif(ls.type == 0) {\nreturn ls.color;\n} else if(ls.type > 0 && ls.type < 4) {\nreturn phong(p, n, si, sh, ls);\n} else if(ls.type == 4) {\nreturn hemisphere(p, n, si, sh, ls);\n} else if(ls.type == 5) {\nreturn sphericalHarmonics(n, ls);\n} else {\nreturn vec3(0);\n}\n}\nvec3 computeLights(vec4 p, vec3 n, float si, float sh) {\nvec3 s = vec3(0);\ns += singleLight(p, n, si, sh, uLight[0]);\ns += singleLight(p, n, si, sh, uLight[1]);\ns += singleLight(p, n, si, sh, uLight[2]);\ns += singleLight(p, n, si, sh, uLight[3]);\nreturn s;\n}\n";
J3D.ShaderSource.Modifiers="//#name Modifiers\n//#description A collection of modifier functions for geometry (only bend for now)\nvec3 bend(vec3 ip, float ba, vec2 b, float o, float a) {\nvec3 op = ip;\nip.x = op.x * cos(a) - op.y * sin(a);\nip.y = op.x * sin(a) + op.y * cos(a);\nif(ba != 0.0) {\nfloat radius = b.y / ba;\nfloat onp = (ip.x - b.x) / b.y - o;\nip.z = cos(onp * ba) * radius - radius;\nip.x = (b.x + b.y * o) + sin(onp * ba) * radius;\n}\nop = ip;\nip.x = op.x * cos(-a) - op.y * sin(-a);\nip.y = op.x * sin(-a) + op.y * cos(-a);\nreturn ip;\n}\n";
J3D.ShaderSource.VertexInclude="//#name VertexInclude\n//#description Common attributes for a mesh - include this in a vertex shader so you don't rewrite this over and over again\nattribute vec3 aVertexPosition;\nattribute vec3 aVertexNormal;\nattribute vec2 aTextureCoord;\nattribute vec2 aTextureCoord2;\nattribute vec4 aVertexColor;\n";J3D.Texture=function(a,b){var c=this;this.tex=gl.createTexture();this.autoLoad=!0;b||(b={});this.isVideo=this.loaded=!1;this.mipmap=b.mipmap!=null?b.mipmap:!0;this.flip=b.flip!=null?b.flip:!0;this.magFilter=b.magFilter||gl.LINEAR;this.minFilter=b.minFilter||gl.LINEAR_MIPMAP_NEAREST;var d=function(){var d=c.src&&c.src.width>0&&c.src.height>0&&(c.src.width&c.src.width-1)==0&&(c.src.height&c.src.height-1)==0;if(!c.wrapMode)c.wrapMode=b.wrapMode||d?gl.REPEAT:gl.CLAMP_TO_EDGE;gl.bindTexture(gl.TEXTURE_2D,
c.tex);gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,c.flip);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,c.src);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,c.magFilter);d?gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,c.minFilter):gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);d?(gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,c.wrapMode),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,c.wrapMode)):(c.wrapMode!=gl.CLAMP_TO_EDGE&&console.warn("WARNING! Texture: "+
a+" : only CLAMP_TO_EDGE wrapMode is supported for non-power-of-2 textures."),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE));c.mipmap&&d&&gl.generateMipmap(gl.TEXTURE_2D);gl.bindTexture(gl.TEXTURE_2D,null);if(b.onLoad)b.onLoad();c.loaded=!0},e=function(a){c.src=new Image;c.src.crossOrigin=b.cors||"";c.src.onload=function(){d()};c.src.src=a},g=function(a){c.isVideo=!0;c.src=document.createElement("video");c.src.src=
a;c.src.preload="auto";c.src.loop=b.loop||"false";c.src.addEventListener("canplaythrough",function(){c.src.play();d()});c.src.load()};if(typeof a=="string")switch(a.substring(a.lastIndexOf(".")+1).toLowerCase()){case "jpg":case "png":case "gif":e(a);break;case "mp4":case "webm":case "ogv":g(a);break;default:b.image?e(a):b.video?g(a):console.log("Texture format not detected from source path and not specifed in params.")}else a.getContext?(c.src=a,d()):a instanceof HTMLVideoElement?(c.isVideo=!0,c.src=
a,c.src.addEventListener("canplaythrough",function(){d()})):(console.log("Video format not recognized: "+typeof a),console.log(a instanceof HTMLVideoElement))};J3D.Texture.prototype.update=function(a){if(a||this.loaded&&this.isVideo)gl.bindTexture(gl.TEXTURE_2D,this.tex),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGB,gl.RGB,gl.UNSIGNED_BYTE,this.src),gl.bindTexture(gl.TEXTURE_2D,null)};J3D.Transform=function(a,b){var c=this,d=[];this.uid=b||0;this.name=a;this.numChildren=0;this.position=v3.ZERO();this.rotation=v3.ZERO();this.scale=v3.ONE();this.worldPosition=v3.ZERO();this.matrix=new SQR.Matrix44;this.globalMatrix=new SQR.Matrix44;this.normalMatrix=new SQR.Matrix33;this.matrixMode=this._lockedMatrix=this.isStatic=!1;this.enabled=!0;this.textureTile=v2.ONE();this.textureOffset=v2.ZERO();var e=new SQR.V3;this.transformDirection=function(a){this.normalMatrix.transformVector(a);return a};
this.forward=function(){e.set(0,0,-1);this.normalMatrix.transformVector(e);return e};this.left=function(){e.set(-1,0,0);this.normalMatrix.transformVector(e);return e};this.add=function(a){for(var b,e=0;e<arguments.length;e++)a=arguments[e],b||(b=a),d.indexOf(a)==-1&&d.push(a),a.parent=c,c.numChildren=d.length;return b};this.contains=function(a){return d.indexOf(a)>-1};this.recurse=function(a){a(c);for(var b=0;b<d.length;b++)d[b].recurse(a)};this.remove=function(a,b){if(c.contains(a))return d.splice(d.indexOf(a),
1),c.numChildren=d.length,a.parent=null,!0;else if(b)for(var e=0;e<d.length;e++){if(d[e].remove(a))return!0}else return!1};this.removeAll=function(){d=[];c.numChildren=0};this.childAt=function(a){return d[a]};this.path=function(){var a=[];a.push(c.name);for(var b=c.parent;b!=null;)a.push(b.name),b=b.parent;return a.reverse().join("/")}};
J3D.Transform.prototype.clone=function(){var a=new J3D.Transform;a.position=this.position.cp();a.rotation=this.rotation.cp();a.scale=this.scale.cp();a.isStatic=this.isStatic;a.renderer=this.renderer;a.geometry=this.geometry;a.camera=this.camera;a.light=this.light;a.collider=this.collider;return a};
J3D.Transform.prototype.updateWorld=function(){if(!this._lockedMatrix){if(!this.matrixMode){var a=this.position,b=this.rotation,c=this.scale;this.matrix.setTRS(a.x,a.y,a.z,b.x,b.y,b.z,c.x,c.y,c.z)}this.parent?(this.parent.globalMatrix.copyTo(this.globalMatrix),this.globalMatrix.multiply(this.matrix)):this.matrix.copyTo(this.globalMatrix);this.globalMatrix.extractPosition(this.worldPosition);this.globalMatrix.copyRotationTo(this.normalMatrix);this.normalMatrix.inverse();this.normalMatrix.transpose();
if(this.isStatic)this._lockedMatrix=!0}};J3D.Transform.prototype.getTileOffset=function(){var a,b;a=this.renderer.textureTile&&this.textureTile.isOne()?this.renderer.textureTile.xy():this.textureTile.xy();b=this.renderer.textureOffset&&this.textureOffset.isZero()?this.renderer.textureOffset.xy():this.textureOffset.xy();return a.concat(b)};
J3D.Transform.prototype.find=function(a){a=a.split("/");for(var b=0;b<this.numChildren;b++)if(this.childAt(b).name==a[0])return a.length==1?this.childAt(b):this.childAt(b).find(a.slice(1).join("/"));return null};J3D.Transform.prototype.updateInverseMat=function(){if(!this.inverseMat)this.inverseMat=new SQR.Matrix44;this.globalMatrix.copyTo(this.inverseMat);this.inverseMat.transpose();this.inverseMat.inverse();return this.inverseMat};J3D.Capabilities={webgl:function(){var a=null;try{var b=document.createElement("canvas");a=b.getContext("webgl")||b.getContext("experimental-webgl")}catch(c){}return a==null?!1:!0}(),userStream:window.navigator.getUserMedia!=null||window.navigator.webkitGetUserMedia!=null,pointerLock:"pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document,gamepad:!!navigator.webkitGamepads||!!navigator.webkitGetGamepads};J3D.Interactor=function(){var a=this;this.centerY=this.centerX=this.normY=this.normX=this.pageY=this.pageX=0;var b=function(b){a.pageX=b.pageX;a.pageY=b.pageY;a.normX=b.pageX/window.innerWidth;a.normY=b.pageY/window.innerHeight;a.centerX=a.normX*2-1;a.centerY=a.normY*2-1};this.destroy=function(){document.removeEventListener("mousemove",b,null)};document.addEventListener("mousemove",b,null)};J3D.PointerLock=function(){function a(){console.log("lockChange");document.pointerLockElement===d||document.mozPointerLockElement===d||document.webkitPointerLockElement===d?(document.addEventListener("mousemove",b,!1),c.pointerLocked=!0,console.log("> locked!")):(document.removeEventListener("mousemove",b,!1),c.pointerLocked=!1,console.log("> unlocked!"))}function b(a){c.deltaX=a.movementX||a.mozMovementX||a.webkitMovementX||0;c.deltaY=a.movementY||a.mozMovementY||a.webkitMovementY||0}var c=this,
d;this.deltaY=this.deltaX=0;this.pointerLocked=!1;document.addEventListener("pointerlockchange",a,!1);document.addEventListener("mozpointerlockchange",a,!1);document.addEventListener("webkitpointerlockchange",a,!1);this.clear=function(){this.deltaX=this.deltaY=0};this.requestLock=function(a){a.requestPointerLock=a.requestPointerLock||a.mozRequestPointerLock||a.webkitRequestPointerLock;a.requestPointerLock();d=a};this.releaseLock=function(){document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||
document.webkitExitPointerLock;document.exitPointerLock()}};J3D.UserStream=function(a){var b=window.navigator,c=!1,d=document.createElement("video");d.autoplay=!0;var e=function(a){console.log(a);throw J3D.Error.USER_STREAM_ERROR;},g=function(b){d.src=c?window.webkitURL.createObjectURL(b):b;a(d)};if(b.getUserMedia)b.getUserMedia({video:!0,audio:!1,captureDelay:2},g,e);else if(b.webkitGetUserMedia)c=!0,b.webkitGetUserMedia({audio:!1,video:!0},g,e);else throw J3D.Error.USER_STREAM_ERROR;};var v2=function(a,b){this.x=a||0;this.y=b||0};v2.prototype.set=function(a,b){this.x=a||0;this.y=b||0};v2.prototype.xy=function(){return[this.x,this.y]};v2.prototype.isOne=function(){return this.x==1&&this.y==1};v2.prototype.isZero=function(){return this.x==0&&this.y==0};v2.ZERO=function(){return new v2(0,0)};v2.ONE=function(){return new v2(1,1)};v2.random=function(){return new v2(Math.random()*2-1,Math.random()*2-1)};var v3=function(a,b,c){this.x=a||0;this.y=b||0;this.z=c||0};v3.prototype.set=function(a,b,c){this.x=a||0;this.y=b||0;this.z=c||0};v3.prototype.fromArray=function(a){this.x=a[0];this.y=a[1];this.z=a[2]};v3.prototype.magSq=function(){return this.x*this.x+this.y*this.y+this.z*this.z};v3.prototype.mag=function(){return Math.sqrt(this.magSq())};v3.prototype.mul=function(a){return new v3(this.x*a,this.y*a,this.z*a)};v3.prototype.neg=function(){this.x=-this.x;this.y=-this.y;this.z=-this.z;return this};
v3.prototype.norm=function(){var a=1/this.mag();this.set(this.x*a,this.y*a,this.z*a);return this};v3.prototype.cp=function(a){a=a||new v3;a.set(this.x,this.y,this.z);return a};v3.prototype.add=function(a){return v3.add(this,a)};v3.prototype.xyz=function(){return[this.x,this.y,this.z]};v3.prototype.toUniform=function(){return this.xyz()};v3.add=function(a,b){var c=new v3(a.x,a.y,a.z);c.x+=b.x;c.y+=b.y;c.z+=b.z;return c};v3.prototype.sub=function(a){return v3.sub(this,a)};
v3.sub=function(a,b){var c=new v3(a.x,a.y,a.z);c.x-=b.x;c.y-=b.y;c.z-=b.z;return c};v3.dot=function(a,b){return a.x*b.x+a.y*b.y+a.z*b.z};v3.cross=function(a,b){return new v3(a.y*b.z-a.z*b.y,a.z*b.x-a.x*b.z,a.x*b.y-a.y*b.x)};v3.ZERO=function(){return new v3(0,0,0)};v3.ONE=function(){return new v3(1,1,1)};v3.RIGHT=function(){return new v3(1,0,0)};v3.UP=function(){return new v3(0,1,0)};v3.FORWARD=function(){return new v3(0,0,-1)};
v3.random=function(){return new v3(Math.random()*2-1,Math.random()*2-1,Math.random()*2-1)};SQR.Matrix2D=function(){typeof Float32Array=="undefined"&&(Float32Array=Array);this.data=new Float32Array(9);var a,b,c,d,e;this.identity=function(){c=this.data;c[0]=1;c[1]=0;c[2]=0;c[3]=0;c[4]=1;c[5]=0;c[6]=0;c[7]=0;c[8]=1;return this};this.transformVector=function(a){c=this.data;d=a.x;e=a.y;a.x=c[0]*d+c[1]*e+c[2];a.y=c[3]*d+c[4]*e+c[5];return a};this.setTranslation=function(a,b,d){c=d||this.data;c[0]=1;c[1]=0;c[2]=a;c[3]=0;c[4]=1;c[5]=b;c[6]=0;c[7]=0;c[8]=1;return this};this.getTranslation=function(a){c=
this.data;a=a||new SQR.V2;a.x=c[2];a.y=c[5];return a};this.setScale=function(a,b,d){c=d||this.data;c[0]=a;c[1]=0;c[2]=0;c[3]=0;c[4]=b;c[5]=0;c[6]=0;c[7]=0;c[8]=1;return this};this.setShear=function(a,b,d){c=d||this.data;c[0]=1;c[1]=a;c[2]=0;c[3]=b;c[4]=1;c[5]=0;c[6]=0;c[7]=0;c[8]=1;return this};this.setRotation=function(a,b){c=b||this.data;var d=Math.cos(a),e=Math.sin(a);c[0]=d;c[1]=-e;c[2]=0;c[3]=e;c[4]=d;c[5]=0;c[6]=0;c[7]=0;c[8]=1;return this};this.setTRS=function(a,b,d,e,f){c=this.data;var g=
Math.cos(d);d=Math.sin(d);c[0]=g*e;c[1]=-d*f;c[2]=a;c[3]=d*e;c[4]=g*f;c[5]=b;c[6]=0;c[7]=0;c[8]=1;return this};this.translate=function(a,b){this.setTranslation(a,b,SQR.Matrix2D.__temp);return this.multiply(SQR.Matrix2D.__temp)};this.rotate=function(a){this.setRotation(a,SQR.Matrix2D.__temp);return this.multiply(SQR.Matrix2D.__temp)};this.scale=function(a,b){this.setScale(a,b,SQR.Matrix2D.__temp);return this.multiply(SQR.Matrix2D.__temp)};this.shear=function(a,b){this.setRotation(a,b,SQR.Matrix2D.__temp);
return this.multiply(SQR.Matrix2D.__temp)};var g,h,i,j,q,m,p,n,o,k,r,t,u,v,f;this.multiply=function(c){a=this.data;b=c.data||c;g=a[0];h=a[1];i=a[2];j=a[3];q=a[4];m=a[5];p=b[0];n=b[1];o=b[2];k=b[3];r=b[4];t=b[5];u=b[6];v=b[7];f=b[8];a[0]=g*p+h*k+i*u;a[1]=g*n+h*r+i*v;a[2]=g*o+h*t+i*f;a[3]=j*p+q*k+m*u;a[4]=j*n+q*r+m*v;a[5]=j*o+q*t+m*f;return this};this.copyTo=function(c){a=this.data;b=c.data||c;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];return c};this.copyFrom=
function(c){a=c.data||c;b=this.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];return this};this.identity()};SQR.Matrix33=function(){typeof Float32Array=="undefined"&&(Float32Array=Array);this.data=new Float32Array(9);this.identity=function(){var a=this.data;a[0]=1;a[3]=0;a[6]=0;a[1]=0;a[4]=1;a[7]=0;a[2]=0;a[5]=0;a[8]=1;return this};this.transformVector=function(a,b){var c=this.data,d=a.x,e=a.y,g=a.z;b=b||a;b.x=c[0]*d+c[3]*e+c[6]*g;b.y=c[1]*d+c[4]*e+c[7]*g;b.z=c[2]*d+c[5]*e+c[8]*g;return b};this.determinant=function(){var a=this.data;return a[0]*(a[4]*a[8]-a[7]*a[5])+a[3]*(a[7]*a[2]-a[1]*a[8])+a[6]*(a[1]*
a[5]-a[4]*a[2])};this.inverse=function(a){var b=this.data;a=a||this.data;var c=b[0],d=b[1],e=b[2],g=b[3],h=b[4],i=b[5],j=b[6],q=b[7],m=b[8],p=m*h-i*q,n=-m*g+i*j,o=q*g-h*j;b=c*p+d*n+e*o;if(!b)return console.warn("Attempt to inverse a singular matrix44. ",this.data),a;b=1/b;a[0]=p*b;a[1]=(-m*d+e*q)*b;a[2]=(i*d-e*h)*b;a[3]=n*b;a[4]=(m*c-e*j)*b;a[5]=(-i*c+e*g)*b;a[6]=o*b;a[7]=(-q*c+d*j)*b;a[8]=(h*c-d*g)*b;return a};this.transpose=function(){var a=this.data,b=a[3],c=a[6],d=a[1],e=a[4],g=a[7],h=a[2],i=
a[5],j=a[8];a[0]=a[0];a[1]=b;a[2]=c;a[3]=d;a[4]=e;a[5]=g;a[6]=h;a[7]=i;a[8]=j}};SQR.Matrix44=function(){typeof Float32Array=="undefined"&&(Float32Array=Array);this.data=new Float32Array(16);this.identity=function(a){a=a||this.data;a[0]=1;a[4]=0;a[8]=0;a[12]=0;a[1]=0;a[5]=1;a[9]=0;a[13]=0;a[2]=0;a[6]=0;a[10]=1;a[14]=0;a[3]=0;a[7]=0;a[11]=0;a[15]=1};this.transformVector=function(a,c){var d=this.data,e=a.x,g=a.y,h=a.z,i=a.w;c=c||a;c.x=d[0]*e+d[4]*g+d[8]*h+d[12]*i;c.y=d[1]*e+d[5]*g+d[9]*h+d[13]*i;c.z=d[2]*e+d[6]*g+d[10]*h+d[14]*i;return c};this.multiply=function(a){var c=this.data,
d=a.data||a,e,g,h,i,j,q,m,p,n,o,k,r,t,u,v,f,l,B,C,D,E,F,G,H,I,y,O,P,Q,R;a=c[0];e=c[1];g=c[2];h=c[3];i=c[4];j=c[5];q=c[6];m=c[7];p=c[8];n=c[9];o=c[10];k=c[11];r=c[12];t=c[13];u=c[14];v=c[15];f=d[0];l=d[1];B=d[2];C=d[3];D=d[4];E=d[5];F=d[6];G=d[7];H=d[8];I=d[9];y=d[10];O=d[11];P=d[12];Q=d[13];R=d[14];d=d[15];c[0]=a*f+i*l+p*B+r*C;c[1]=e*f+j*l+n*B+t*C;c[2]=g*f+q*l+o*B+u*C;c[3]=h*f+m*l+k*B+v*C;c[4]=a*D+i*E+p*F+r*G;c[5]=e*D+j*E+n*F+t*G;c[6]=g*D+q*E+o*F+u*G;c[7]=h*D+m*E+k*F+v*G;c[8]=a*H+i*I+p*y+r*O;c[9]=
e*H+j*I+n*y+t*O;c[10]=g*H+q*I+o*y+u*O;c[11]=h*H+m*I+k*y+v*O;c[12]=a*P+i*Q+p*R+r*d;c[13]=e*P+j*Q+n*R+t*d;c[14]=g*P+q*Q+o*R+u*d;c[15]=h*P+m*Q+k*R+v*d;return this};this.setTQS=function(a,c,d,e,g,h,i,j,q,m,p){var n=p||this.data;this.identity(p);var o=g*g,k=h*h,r=i*i;n[0]=(1-2*k-2*r)*j;n[1]=(2*g*h-2*i*e)*j;n[2]=(2*g*i+2*h*e)*j;n[4]=(2*g*h+2*i*e)*q;n[5]=(1-2*o-2*r)*q;n[6]=(2*h*i-2*g*e)*q;n[8]=(2*g*i-2*h*e)*m;n[9]=(2*h*i+2*g*e)*m;n[10]=(1-2*o-2*k)*m;n[12]=a;n[13]=c;n[14]=d;return p||this};this.setTRS=function(a,
c,d,e,g,h,i,j,q,m){var p=m||this.data;this.identity(m);var n=Math.sin(e);e=Math.cos(e);var o=Math.sin(g);g=Math.cos(g);var k=Math.sin(h);h=Math.cos(h);p[0]=(g*h+o*n*k)*i;p[1]=(-g*k+o*n*h)*i;p[2]=o*e*i;p[4]=k*e*j;p[5]=h*e*j;p[6]=-n*j;p[8]=(-o*h+g*n*k)*q;p[9]=(k*o+g*n*h)*q;p[10]=g*e*q;p[12]=a;p[13]=c;p[14]=d;return m||this};this.setScale=function(a,c,d,e){var g=e||this.data;this.identity(e);g[0]=a;g[5]=c;g[10]=d;return e||this};this.setTranslation=function(a,c,d,e){var g=e||this.data;this.identity(e);
g[12]=a;g[13]=c;g[14]=d;return e||this};this.setRotation=function(a,c,d,e){var g=e||this.data;this.identity(e);var h=Math.sin(a);a=Math.cos(a);var i=Math.sin(c);c=Math.cos(c);var j=Math.sin(d);d=Math.cos(d);g[0]=c*d+i*h*j;g[1]=-c*j+i*h*d;g[2]=i*a;g[4]=j*a;g[5]=d*a;g[6]=-h;g[8]=-i*d+c*h*j;g[9]=j*i+c*h*d;g[10]=c*a;return e||this};this.translate=function(a,c,d){this.setTranslation(a,c,d,SQR.Matrix44.__temp);return this.multiply(SQR.Matrix44.__temp)};this.rotate=function(a,c,d){this.setRotation(a,c,d,
SQR.Matrix44.__temp);return this.multiply(SQR.Matrix44.__temp)};this.scale=function(a,c,d){this.setScale(a,c,d,SQR.Matrix44.__temp);return this.multiply(SQR.Matrix44.__temp)};this.copyTo=function(a){for(var c=this.data,d=a.data||a,e=0;e<16;e++)d[e]=c[e];return a};this.copyRotationTo=function(a){var c=this.data,d=a.data||a;d[0]=c[0];d[1]=c[1];d[2]=c[2];d[3]=c[4];d[4]=c[5];d[5]=c[6];d[6]=c[8];d[7]=c[9];d[8]=c[10];return a};var a=function(a){return Math.abs(a)<1.0E-6?0:a};this.getAsCSSProperty=function(){var b=
this.data;return"matrix3d("+a(b[0])+","+a(b[1])+","+a(b[2])+","+a(b[3])+","+a(b[4])+","+a(b[5])+","+a(b[6])+","+a(b[7])+","+a(b[8])+","+a(b[9])+","+a(b[10])+","+a(b[11])+","+a(b[12])+","+a(b[13])+","+a(b[14])+","+a(b[15])+")"};this.extractPosition=function(a){var c=this.data;a.set(c[12],c[13],c[14]);return a};this.determinant=function(){var a=this.data;return a[0]*(a[5]*a[10]-a[9]*a[6])+a[4]*(a[9]*a[2]-a[1]*a[10])+a[8]*(a[1]*a[6]-a[5]*a[2])};this.inverse=function(a){var c=this.data,d=a?a.data||a:
this.data,e=this.determinant();if(Math.abs(e)<1.0E-4)return console.warn("Attempt to inverse a singular matrix44. ",this.data),console.trace(),a;var g=c[0],h=c[4],i=c[8],j=c[12],q=c[1],m=c[5],p=c[9],n=c[13],o=c[2],k=c[6],r=c[10];c=c[14];e=1/e;d[0]=(m*r-p*k)*e;d[4]=(i*k-h*r)*e;d[8]=(h*p-i*m)*e;d[1]=(p*o-q*r)*e;d[5]=(g*r-i*o)*e;d[9]=(i*q-g*p)*e;d[2]=(q*k-m*o)*e;d[6]=(h*o-g*k)*e;d[10]=(g*m-h*q)*e;d[12]=-(j*d[0]+n*d[1]+c*d[2]);d[13]=-(j*d[4]+n*d[5]+c*d[6]);d[14]=-(j*d[8]+n*d[9]+c*d[10]);return a};this.transpose=
function(){var a=this.data,c=a[4],d=a[8],e=a[1],g=a[5],h=a[9],i=a[2],j=a[6],q=a[10];a[0]=a[0];a[1]=c;a[2]=d;a[4]=e;a[5]=g;a[6]=h;a[8]=i;a[9]=j;a[10]=q};this.lookAt=function(a,c){var d=this.data,e=SQR.Matrix44.__tv1,g=SQR.Matrix44.__tv2,h=SQR.Matrix44.__tv3;h.set(d[12],d[13],d[14]);h.sub(h,a).norm();if(h.magsq()===0)h.z=1;e.cross(c,h).norm();e.magsq()===0&&(h.x+=1.0E-4,e.cross(c,h).norm());g.cross(h,e);d[0]=e.x;d[4]=g.x;d[8]=h.x;d[1]=e.y;d[5]=g.y;d[9]=h.y;d[2]=e.z;d[6]=g.z;d[10]=h.z;return this};this.identity()};SQR.ProjectionMatrix=function(){typeof Float32Array=="undefined"&&(Float32Array=Array);this.data=new Float32Array(16);this.copyTo=function(a){for(var b=this.data,c=a.data||a,d=0;d<16;d++)c[d]=b[d];return a};this.identity()};SQR.ProjectionMatrix.prototype.identity=function(){var a=this.data;a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1};
SQR.ProjectionMatrix.prototype.perspective=function(a,b,c,d){var e=this.data;a=c*Math.tan(a*Math.PI/360);var g=d-c;e[0]=c/(a*b);e[4]=0;e[8]=0;e[12]=0;e[1]=0;e[5]=c/a;e[9]=0;e[13]=0;e[2]=0;e[6]=0;e[10]=-(d+c)/g;e[14]=-(2*d*c)/g;e[3]=0;e[7]=0;e[11]=-1;e[15]=0};SQR.ProjectionMatrix.prototype.transformVector=function(a,b){var c=a.x,d=a.y,e=a.z,g=a.w,h=this.data;b=b||a;b.x=h[0]*c+h[4]*d+h[8]*e+h[12]*g;b.y=h[1]*c+h[5]*d+h[9]*e+h[13]*g;b.z=h[2]*c+h[6]*d+h[10]*e+h[14]*g;return b};
SQR.ProjectionMatrix.prototype.inverse=function(a){var b=this.data;a=a||this.data;var c=b[0],d=b[1],e=b[2],g=b[3],h=b[4],i=b[5],j=b[6],q=b[7],m=b[8],p=b[9],n=b[10],o=b[11],k=b[12],r=b[13],t=b[14];b=b[15];var u=c*i-d*h,v=c*j-e*h,f=c*q-g*h,l=d*j-e*i,B=d*q-g*i,C=e*q-g*j,D=m*r-p*k,E=m*t-n*k,F=m*b-o*k,G=p*t-n*r,H=p*b-o*r,I=n*b-o*t,y=u*I-v*H+f*G+l*F-B*E+C*D;if(!y)return null;y=1/y;a[0]=(i*I-j*H+q*G)*y;a[1]=(-d*I+e*H-g*G)*y;a[2]=(r*C-t*B+b*l)*y;a[3]=(-p*C+n*B-o*l)*y;a[4]=(-h*I+j*F-q*E)*y;a[5]=(c*I-e*F+g*
E)*y;a[6]=(-k*C+t*f-b*v)*y;a[7]=(m*C-n*f+o*v)*y;a[8]=(h*H-i*F+q*D)*y;a[9]=(-c*H+d*F-g*D)*y;a[10]=(k*B-r*f+b*u)*y;a[11]=(-m*B+p*f-o*u)*y;a[12]=(-h*G+i*E-j*D)*y;a[13]=(c*G-d*E+e*D)*y;a[14]=(-k*l+r*v-t*u)*y;a[15]=(m*l-p*v+n*u)*y;return a};SQR.Quaternion=function(a,b,c,d){this.set(a,b,c,d)};SQR.Quaternion.prototype.set=function(a,b,c,d){this.w=a||1;this.x=b||0;this.y=c||0;this.z=d||0};SQR.Quaternion.prototype.copyFrom=function(a){this.w=a.w;this.x=a.x;this.y=a.y;this.z=a.z};SQR.Quaternion.prototype.identity=function(){this.set()};SQR.Quaternion.prototype.mul=function(a,b){b=b||this;b.set(b.w*a.w-b.x*a.x-b.y*a.y-b.z*a.z,b.w*a.x+b.x*a.w+b.y*a.z-b.z*a.y,b.w*a.y-b.x*a.z+b.y*a.w+b.z*a.x,b.w*a.z+b.x*a.y-b.y*a.x+b.z*a.w);b.normalize();return b};
SQR.Quaternion.prototype.fromAngleAxis=function(a,b,c,d){var e=Math.sin(a/2);this.x=b*e;this.y=c*e;this.z=d*e;this.w=Math.cos(a/2)};SQR.Quaternion.prototype.mag=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)};SQR.Quaternion.prototype.normalize=function(){var a=this.mag();this.x/=a;this.y/=a;this.z/=a;this.w/=a};SQR.Quaternion.prototype.toMatrix=function(){};
SQR.Quaternion.slerp=function(a,b,c,d){d=d||new SQR.Quaternion;var e=a.w*b.w+a.x*b.x+a.y*b.y+a.z*b.z,g=Math.acos(e),h=Math.sqrt(1-e*e),i=Math.sin((1-c)*g)/h;c=Math.sin(c*g)/h;Math.abs(e)>=1?(i=1,c=0):Math.abs(h)<0.0010&&(c=i=0.5);d.w=a.w*i+b.w*c;d.x=a.x*i+b.x*c;d.y=a.y*i+b.y*c;d.z=a.z*i+b.z*c;return d};SQR.V2=function(a,b){this.x=a||0;this.y=b||0};SQR.V2.prototype.set=function(a,b){this.x=a||0;this.y=b||0;return this};SQR.V2.prototype.add=function(a,b){this.x=a.x+b.x;this.y=a.y+b.y;return this};SQR.V2.prototype.mul=function(a){this.x*=a;this.y*=a;return this};SQR.V2.prototype.magsq=function(){return this.x*this.x+this.y*this.y};SQR.V2.prototype.mag=function(){return Math.sqrt(this.magsq())};SQR.V2.prototype.norm=function(){var a=this.mag();if(a==0)return this;this.x/=a;this.y/=a;return this};
SQR.V2.prototype.sub=function(a,b){b=b||new SQR.V2;b.x=a.x-this.x;b.y=a.y-this.y;return b};SQR.V2.prototype.isZero=function(){return this.x==0&&this.y==0};SQR.V2.random=function(){return new SQR.V2(Math.random()*2-1,Math.random()*2-1)};SQR.V2.prototype.setAngleRadius=function(a,b){this.x=Math.cos(a)*b;this.y=Math.sin(a)*b;return this};SQR.V2.prototype.addc=function(a,b){this.x+=a;this.y+=b;return this};SQR.V2.prototype.addAngleRadius=function(a,b){this.x+=Math.cos(a)*b;this.y+=Math.sin(a)*b;return this};SQR.V3=function(a,b,c,d){this.x=a||0;this.y=b||0;this.z=c||0;this.w=d||1};SQR.V3.prototype.set=function(a,b,c,d){this.x=a||0;this.y=b||0;this.z=c||0;this.w=d||1;return this};SQR.V3.prototype.append=function(a,b,c,d){this.x+=a||0;this.y+=b||0;this.z+=c||0;this.w+=d||0;return this};SQR.V3.prototype.copyTo=function(a){a.x=this.x;a.y=this.y;a.z=this.z;a.w=this.w;return a};SQR.V3.prototype.copy=function(){return new SQR.V3(this.x,this.y,this.z,this.w)};
SQR.V3.prototype.copyFrom=function(a){this.x=a.x;this.y=a.y;this.z=a.z;this.w=a.w;return this};SQR.V3.prototype.magsq=function(){return this.x*this.x+this.y*this.y+this.z*this.z};SQR.V3.prototype.mag=function(){return Math.sqrt(this.magsq())};SQR.V3.prototype.isZero=function(){return this.x==0&&this.y==0&&this.z==0};SQR.V3.prototype.mul=function(a){this.x*=a;this.y*=a;this.z*=a;return this};SQR.V3.prototype.neg=function(){this.x=-this.x;this.y=-this.y;this.z=-this.z;return this};
SQR.V3.prototype.norm=function(){var a=1/this.mag();this.set(this.x*a,this.y*a,this.z*a);return this};SQR.V3.prototype.add=function(a,b){this.x=a.x+b.x;this.y=a.y+b.y;this.z=a.z+b.z;return this};SQR.V3.prototype.sub=function(a,b){this.x=a.x-b.x;this.y=a.y-b.y;this.z=a.z-b.z;return this};SQR.V3.dot=function(a,b){return a.x*b.x+a.y*b.y+a.z*b.z};SQR.V3.prototype.toUniform=function(){return[this.x,this.y,this.z]};
SQR.V3.prototype.cross=function(a,b){this.set(a.y*b.z-a.z*b.y,a.z*b.x-a.x*b.z,a.x*b.y-a.y*b.x,this.w);return this};SQR.V3.up=new SQR.V3(0,1,0);SQR.Quaternion.__tv1=new SQR.V3;SQR.Quaternion.__tv2=new SQR.V3;SQR.Quaternion.__tv3=new SQR.V3;SQR.Matrix2D.__temp=new Float32Array(9);SQR.Matrix33.__temp=new Float32Array(9);SQR.Matrix44.__temp=new Float32Array(16);SQR.Matrix44.__tv1=new SQR.V3;SQR.Matrix44.__tv2=new SQR.V3;SQR.Matrix44.__tv3=new SQR.V3;SQR.VectorUtil={mouseToUnitSphereVector:function(a,b,c,d){c=c||0.5;d=d||new SQR.V3;a/=c;b/=c;c=a*a+b*b;c>=1?d.set(a,b,0):d.set(a,b,Math.sqrt(1-c));d.norm();return d}};J3D.Color=function(a,b,c,d){var e=this;this.r=a||0;this.g=b||0;this.b=c||0;this.a=d||0;this.rgba=function(){return[e.r,e.g,e.b,e.a]};this.rgb=function(){return[e.r,e.g,e.b]};this.toUniform=function(a){return a==gl.FLOAT_VEC3?this.rgb():this.rgba()};this.toRGB=function(){return"rgb("+(this.r*255|0)+","+(this.g*255|0)+","+(this.b*255|0)+")"}};J3D.Color.white=new J3D.Color(1,1,1,1);J3D.Color.black=new J3D.Color(0,0,0,1);J3D.Color.red=new J3D.Color(1,0,0,1);J3D.Color.green=new J3D.Color(0,1,0,1);
J3D.Color.blue=new J3D.Color(0,0,1,1);J3D.Error={};J3D.Error.NO_WEBGL_CONTEXT="No webgl context. Looks like your browser does not support webgl";J3D.Error.NO_CAMERA="Missing camera. Please assign a transform with a camera attached to engine.camera";J3D.Error.NO_BUILTIN_SHADER="Built-in shader not found: ";J3D.Error.UNKNOWN_COLLIDER_TYPE="Unrecognized collider type: ";J3D.Error.SHADER_COMPILE_ERROR="Shader compile error: ";J3D.Error.USER_STREAM_ERROR="UserStream not supported";J3D.GeometryUtil={randomNoise:function(a,b){for(var c=a.arraysByName[J3D.Mesh.VERTEX_POSITION],d=c.data,e=0;e<d.length;e++)d[e]+=b*Math.random();a.replaceArray(c,d)}};J3D.Intersection={};J3D.Intersection.rayTest=function(a,b){if(!b.collider)return console.log("Intersection test failed. "+b.name+" has no collider."),!1;switch(b.collider.type){case J3D.Collider.SPHERE:return J3D.Intersection.raySphere(a,b);case J3D.Collider.BOX:return J3D.Intersection.rayBox(a,b);case J3D.Collider.MESH:return J3D.Intersection.rayMesh(a,b);default:throw J3D.Error.UNKNOWN_COLLIDER_TYPE+b.collider.type;}};
J3D.Intersection.rayMesh=function(a,b){if(!b.collider.mesh||!b.collider.mesh.vertexPositionBuffer)return console.log("Intersection test failed. "+b.name+" has no mesh defined or no vertex data in the mesh."),!1;if(b.collider.box){if(!J3D.Intersection.rayBox(a,b))return!1}else a.makeLocal(b);for(var c=b.collider.mesh.vertexPositionBuffer.data,d=b.collider.mesh.elements.data,e=!1,g=0;g<d.length;g+=3){var h=d[g+0]*3,i=d[g+1]*3,j=d[g+2]*3;h=new v3(c[h],c[h+1],c[h+2]);i=new v3(c[i],c[i+1],c[i+2]);j=new v3(c[j],
c[j+1],c[j+2]);if(e=e||J3D.Intersection.rayTriangle(a,h,i,j))break}return e};
J3D.Intersection.rayTriangle=function(a,b,c,d){var e=v3.sub(b,c),g=v3.sub(b,d);g=v3.cross(g,e);var h=v3.dot(g,a.localDirection);if(!(h<0))return!1;e=v3.dot(g,b)-v3.dot(g,a.localOrigin);if(!(e<=0))return!1;e/=h;var i=a.localDirection.norm().mul(e);i=v3.add(i,a.localOrigin);Math.abs(g.x)>Math.abs(g.y)?Math.abs(g.x)>Math.abs(g.z)?(a=i.y-b.y,g=c.y-b.y,h=d.y-b.y,i=i.z-b.z,c=c.z-b.z,d=d.z-b.z):(a=i.x-b.x,g=c.x-b.x,h=d.x-b.x,i=i.y-b.y,c=c.y-b.y,d=d.y-b.y):Math.abs(g.y)>Math.abs(g.z)?(a=i.x-b.x,g=c.x-b.x,
h=d.x-b.x,i=i.z-b.z,c=c.z-b.z,d=d.z-b.z):(a=i.x-b.x,g=c.x-b.x,h=d.x-b.x,i=i.y-b.y,c=c.y-b.y,d=d.y-b.y);b=g*d-c*h;if(b==0)return!1;b=1/b;d=(a*d-i*h)*b;if(!(d>=0))return!1;b*=g*i-c*a;if(!(b>=0))return!1;if(!(1-d-b>=0))return!1;return e};
J3D.Intersection.raySphere=function(a,b){if(!b.collider.radius)return console.log("Intersection test failed. "+b.name+" has no radius defined."),!1;var c=b.collider.radius;c*=c;a.makeLocal(b);var d=b.collider.center.sub(a.localOrigin);if(d.lengthSq<c)return!1;var e=v3.dot(d,a.localDirection);if(e<=0)return!1;b=c-(d.magSq()-e*e);if(b>=0)return Math.abs(e)-Math.sqrt(b);return!1};
J3D.Intersection.rayBox=function(a,b){if(!b.collider.box)return console.log("Intersection test failed. "+b.name+" has no box defined."),!1;var c=b.collider.box;a.makeLocal(b);var d=0,e=0,g=0,h=!0;a.localOrigin.x<c.minX?(d=c.minX-a.localOrigin.x,d/=a.localDirection.x,h=!1):a.localOrigin.x>c.maxX&&(d=c.maxX-a.localOrigin.x,d/=a.localDirection.x,h=!1);a.localOrigin.y<c.minY?(e=c.minY-a.localOrigin.y,e/=a.localDirection.y,h=!1):a.localOrigin.y>c.maxY&&(e=c.maxY-a.localOrigin.y,e/=a.localDirection.y,h=
!1);a.localOrigin.z<c.minZ?(g=c.minZ-a.localOrigin.z,g/=a.localDirection.z,h=!1):a.localOrigin.z>c.maxZ&&(g=c.maxZ-a.localOrigin.z,g/=a.localDirection.z,h=!1);if(h)return-1;h=0;e>d&&(h=1,d=e);g>d&&(h=2,d=g);switch(h){case 0:e=a.localOrigin.y+a.localDirection.y*d;if(e<c.minY||e>c.maxY)return!1;e=a.localOrigin.z+a.localDirection.z*d;if(e<c.minZ||e>c.maxZ)return!1;break;case 1:e=a.localOrigin.x+a.localDirection.x*d;if(e<c.minX||e>c.maxX)return!1;e=a.localOrigin.z+a.localDirection.z*d;if(e<c.minZ||e>
c.maxZ)return!1;break;case 2:e=a.localOrigin.x+a.localDirection.x*d;if(e<c.minX||e>c.maxX)return!1;e=a.localOrigin.y+a.localDirection.y*d;if(e<c.minY||e>c.maxY)return!1}return d};J3D.MathUtil={getBoundsAtDistance:function(a,b){var c=b*Math.tan(a.fov/180*Math.PI/2);return{w:c*(gl.viewportWidth/gl.viewportHeight),h:c}},calculateTangents:function(a){a.tangents=[];for(var b=[],c=[],d,e,g,h,i,j,q,m,p,n,o,k=0;k<a.tris.length;k+=3){var r=a.tris[k+0],t=a.tris[k+1],u=a.tris[k+2];j=new v3(a.vertices[r*3+0],a.vertices[r*3+1],a.vertices[r*3+2]);e=new v3(a.vertices[t*3+0],a.vertices[t*3+1],a.vertices[t*3+2]);q=new v3(a.vertices[u*3+0],a.vertices[u*3+1],a.vertices[u*3+2]);o=new v2(a.uv1[r*
2+0],a.uv1[r*2+1]);m=new v2(a.uv1[t*2+0],a.uv1[t*2+1]);n=new v2(a.uv1[u*2+0],a.uv1[u*2+1]);d=e.x-j.x;g=e.y-j.y;i=e.z-j.z;e=q.x-j.x;h=q.y-j.y;j=q.z-j.z;q=m.x-o.x;p=m.y-o.y;m=n.x-o.x;n=n.y-o.y;o=1/(q*n-m*p);n=new v3((n*d-p*e)*o,(n*g-p*h)*o,(n*i-p*j)*o);d=new v3((q*e-m*d)*o,(q*h-m*g)*o,(q*j-m*i)*o);b[r]||(b[r]=new v3);b[t]||(b[t]=new v3);b[u]||(b[u]=new v3);c[r]||(c[r]=new v3);c[t]||(c[t]=new v3);c[u]||(c[u]=new v3);b[r]=b[r].add(n);b[t]=b[t].add(n);b[u]=b[u].add(n);c[r]=c[r].add(d);c[t]=c[t].add(d);
c[u]=c[u].add(d)}for(k=0;k<a.vertices.length;k+=3)d=Math.floor(k/3),u=new v3(a.normals[k+0],a.normals[k+1],a.normals[k+2]),t=b[d],r=v3.sub(t,u.mul(v3.dot(u,t))).norm(),t=v3.dot(v3.cross(u,t),c[d])<0?-1:1,a.tangents.push(r.x,r.y,r.z,t)}};J3D.ParticleUtil={};J3D.ParticleUtil.insideCube=function(a,b,c){var d=new Float32Array(a*3);c=c||v3.ZERO();b/=2;for(var e=0;e<a*3;e+=3)d[e]=c.x+Math.random()*b*2-b+Math.random(),d[e+1]=c.y+Math.random()*b*2-b+Math.random(),d[e+2]=c.z+Math.random()*b*2-b+Math.random();return d};J3D.ParticleUtil.onSphere=function(a,b,c,d){var e=new Float32Array(a*3);d||v3.ZERO();c=c==null?1:c;d=new v3;for(var g=0;g<a*3;g+=3)d.random().norm().mul(b+Math.random()*c),e[g]=d.x,e[g+1]=d.y,e[g+2]=d.z;return e};
J3D.ParticleUtil.randomColors=function(a,b,c){var d=new Float32Array(a*4);c=(c==null?1:c)-b;for(var e=0;e<a*4;e++)d[e]=b+Math.random()*c;return d};J3D.ShaderUtil={};J3D.ShaderUtil.setTexture=function(a,b,c,d){gl.activeTexture(33984+b);d.update&&d.update();if(d.tex)d=d.tex;gl.bindTexture(gl.TEXTURE_2D,d);gl.uniform1i(a.uniforms[c].location,b)};J3D.ShaderUtil.setTextureCube=function(a,b,c,d){gl.activeTexture(33984+b);gl.bindTexture(gl.TEXTURE_CUBE_MAP,d.tex);gl.uniform1i(a.uniforms[c].location,b)};
J3D.ShaderUtil.setAttributes=function(a,b){for(var c=0;c<b.arrays.length;c++){var d=b.arrays[c];a.attributes[d.name]!=null&&(gl.bindBuffer(gl.ARRAY_BUFFER,d.buffer),gl.vertexAttribPointer(a.attributes[d.name],d.itemSize,gl.FLOAT,!1,0,0))}};
J3D.ShaderUtil.setLights=function(a,b){for(var c=0;c<J3D.SHADER_MAX_LIGHTS;c++){var d=b[c];d&&a.uniforms["uLight["+c+"].type"]?(gl.uniform1i(a.uniforms["uLight["+c+"].type"].location,d.light.type),gl.uniform3fv(a.uniforms["uLight["+c+"].direction"].location,d.forward().toUniform()),gl.uniform3fv(a.uniforms["uLight["+c+"].color"].location,d.light.color.rgb()),gl.uniform3fv(a.uniforms["uLight["+c+"].position"].location,d.worldPosition.xyz()),gl.uniform1f(a.uniforms["uLight["+c+"].intensity"].location,
d.light.intensity),gl.uniform1f(a.uniforms["uLight["+c+"].angleFalloff"].location,d.light.angleFalloff),gl.uniform1f(a.uniforms["uLight["+c+"].angle"].location,d.light.angle)):a.uniforms["uLight["+c+"].type"]&&gl.uniform1i(a.uniforms["uLight["+c+"].type"].location,J3D.NONE)}};J3D.ShaderUtil.isTexture=function(a){return a==gl.SAMPLER_2D||a==gl.SAMPLER_CUBE};
J3D.ShaderUtil.getTypeName=function(a){switch(a){case gl.BYTE:return"BYTE (0x1400)";case gl.UNSIGNED_BYTE:return"UNSIGNED_BYTE (0x1401)";case gl.SHORT:return"SHORT (0x1402)";case gl.UNSIGNED_SHORT:return"UNSIGNED_SHORT (0x1403)";case gl.INT:return"INT (0x1404)";case gl.UNSIGNED_INT:return"UNSIGNED_INT (0x1405)";case gl.FLOAT:return"FLOAT (0x1406)";case gl.FLOAT_VEC2:return"FLOAT_VEC2 (0x8B50)";case gl.FLOAT_VEC3:return"FLOAT_VEC3 (0x8B51)";case gl.FLOAT_VEC4:return"FLOAT_VEC4 (0x8B52)";case gl.INT_VEC2:return"INT_VEC2   (0x8B53)";
case gl.INT_VEC3:return"INT_VEC3   (0x8B54)";case gl.INT_VEC4:return"INT_VEC4   (0x8B55)";case gl.BOOL:return"BOOL \t\t(0x8B56)";case gl.BOOL_VEC2:return"BOOL_VEC2  (0x8B57)";case gl.BOOL_VEC3:return"BOOL_VEC3  (0x8B58)";case gl.BOOL_VEC4:return"BOOL_VEC4  (0x8B59)";case gl.FLOAT_MAT2:return"FLOAT_MAT2 (0x8B5A)";case gl.FLOAT_MAT3:return"FLOAT_MAT3 (0x8B5B)";case gl.FLOAT_MAT4:return"FLOAT_MAT4 (0x8B5C)";case gl.SAMPLER_2D:return"SAMPLER_2D (0x8B5E)";case gl.SAMPLER_CUBE:return"SAMPLER_CUBE (0x8B60)";
default:return"Unknown ("+a.toString(16)+")"}};
J3D.ShaderUtil.setUniform=function(a,b,c){var d=b.uniforms[a];if(d)switch(c=c[a],c.toUniform&&(c=c.toUniform(d.type)),d.type){case gl.BYTE:gl.uniform1i(d.location,c);break;case gl.UNSIGNED_BYTE:gl.uniform1i(d.location,c);break;case gl.SHORT:gl.uniform1i(d.location,c);break;case gl.UNSIGNED_SHORT:gl.uniform1i(d.location,c);break;case gl.INT:gl.uniform1i(d.location,c);break;case gl.INT_VEC2:gl.uniform2iv(d.location,c);break;case gl.INT_VEC3:gl.uniform3iv(d.location,c);break;case gl.INT_VEC4:gl.uniform4iv(d.location,
c);break;case gl.UNSIGNED_INT:gl.uniform1i(d.location,c);break;case gl.FLOAT:gl.uniform1f(d.location,c);break;case gl.FLOAT_VEC2:gl.uniform2fv(d.location,c);break;case gl.FLOAT_VEC3:gl.uniform3fv(d.location,c);break;case gl.FLOAT_VEC4:gl.uniform4fv(d.location,c);break;case gl.BOOL:gl.uniform1i(d.location,c);break;case gl.BOOL_VEC2:gl.uniform2iv(d.location,c);break;case gl.BOOL_VEC3:gl.uniform3iv(d.location,c);break;case gl.BOOL_VEC4:gl.uniform4iv(d.location,c);break;case gl.FLOAT_MAT2:gl.uniformMatrix2fv(d.location,
!1,c);break;case gl.FLOAT_MAT3:gl.uniformMatrix3fv(d.location,!1,c);break;case gl.FLOAT_MAT4:gl.uniformMatrix4fv(d.location,!1,c);break;case gl.SAMPLER_2D:J3D.ShaderUtil.setTexture(b,d.texid,a,c);break;case gl.SAMPLER_CUBE:J3D.ShaderUtil.setTextureCube(b,d.texid,a,c);break;default:return"WARNING! Unknown uniform type ( 0x"+d.type.toString(16)+" )"}};
J3D.ShaderUtil.parseGLSL=function(a){a=a.split("\n");var b="",c="",d={};d.common="";d.includes=[];d.vertexIncludes=[];d.fragmentIncludes=[];for(var e=0,g=function(a,b){var c=b.indexOf(a);if(c>-1)return b.substring(c+a.length+1);return null},h=0;h<a.length;h++)if(a[h].indexOf("//#")>-1)if(a[h].indexOf("//#fragment")>-1)e++;else if(a[h].indexOf("//#vertex")>-1)e++;else{d.name=d.name||g("name",a[h]);var i=g("include",a[h]);if(i)switch(e){case 0:d.includes.push(i);break;case 1:d.vertexIncludes.push(i);
break;case 2:d.fragmentIncludes.push(i)}}else switch(i=a[h],i.indexOf("//")>-1&&(i=i.substring(0,i.indexOf("//"))),e){case 0:d.common+=i+"\n";break;case 1:b+=i+"\n";break;case 2:c+=i+"\n"}return new J3D.Shader(d.name||"Shader"+Math.round(Math.random()*1E3),b,c,d)};J3D.Time={};J3D.Time.time=0;J3D.Time.startTime=0;J3D.Time.timeOffset=0;J3D.Time.lastTime=0;J3D.Time.deltaTime=0;J3D.Time.tick=function(){var a=(new Date).getTime();if(J3D.Time.startTime==0)J3D.Time.startTime=a;if(J3D.Time.lastTime!=0)J3D.Time.deltaTime=a-J3D.Time.lastTime;J3D.Time.lastTime=a;J3D.Time.time=(a-J3D.Time.startTime)/1E3};J3D.Time.getTime=function(){J3D.Time.tick();return J3D.Time.deltaTime};J3D.Time.pause=function(){J3D.Time.timeOffset=(new Date).getTime()};
J3D.Time.resume=function(){J3D.Time.startTime+=(new Date).getTime()-J3D.Time.timeOffset;J3D.Time.lastTime=J3D.Time.deltaTime=0};J3D.Time.formatTime=function(a,b){if(!a)a=J3D.Time.time;var c=Math.floor(a%1*100),d=Math.floor(a)%60,e=Math.floor(a/60);c<10&&(c="0"+c);c==100&&(c="00");d<10&&(d="0"+d);e<10&&(e="0"+e);return b?e+":"+d+":"+c:e+":"+d};
