
<html>
<head>
    <title>021 | Video Compositing | J3D</title>

    <meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">

    <link rel="stylesheet" href="common/common.css"/>
    
    <script type="text/javascript" src="common/common.js"></script>
    <script type="text/javascript" src="js/TweenLite.min.js"></script>

    <style type="text/css">

        #videos video, #videos canvas {
            position: absolute;
            top: 50%;
            left: 50%;
            margin-left: -512px;
            margin-top: -288px;
        }

        #debug {
            display: inline-block;
            background-color: #ffffff;
            position: absolute;
            top: 5px;
            left: 5px;
        }

    </style>

<!-- J3DLIB -->
<!-- Auto-generated by tools/demojstags.py. Do not edit this section -->
<script type="text/javascript" src="../lib/requestAnimationFrame.js"></script>
<script type="text/javascript" src="../src/J3D.js"></script>
<script type="text/javascript" src="../src/SQR.js"></script>
<script type="text/javascript" src="../src/engine/AssetLoader.js"></script>
<script type="text/javascript" src="../src/engine/BuiltinShaders.js"></script>
<script type="text/javascript" src="../src/engine/Camera.js"></script>
<script type="text/javascript" src="../src/engine/Collider.js"></script>
<script type="text/javascript" src="../src/engine/Cubemap.js"></script>
<script type="text/javascript" src="../src/engine/Engine.js"></script>
<script type="text/javascript" src="../src/engine/FrameBuffer.js"></script>
<script type="text/javascript" src="../src/engine/Geometry.js"></script>
<script type="text/javascript" src="../src/engine/Light.js"></script>
<script type="text/javascript" src="../src/engine/Loader.js"></script>
<script type="text/javascript" src="../src/engine/Mesh.js"></script>
<script type="text/javascript" src="../src/engine/Postprocess.js"></script>
<script type="text/javascript" src="../src/engine/Primitives.js"></script>
<script type="text/javascript" src="../src/engine/Ray.js"></script>
<script type="text/javascript" src="../src/engine/Scene.js"></script>
<script type="text/javascript" src="../src/engine/Shader.js"></script>
<script type="text/javascript" src="../src/engine/ShaderAtlas.js"></script>
<script type="text/javascript" src="../src/engine/ShaderSource.js"></script>
<script type="text/javascript" src="../src/engine/Texture.js"></script>
<script type="text/javascript" src="../src/engine/Transform.js"></script>
<script type="text/javascript" src="../src/extras/Capabilities.js"></script>
<script type="text/javascript" src="../src/extras/Interactor.js"></script>
<script type="text/javascript" src="../src/extras/PointerLock.js"></script>
<script type="text/javascript" src="../src/extras/UserStream.js"></script>
<script type="text/javascript" src="../src/legacy-math/Vector2.js"></script>
<script type="text/javascript" src="../src/legacy-math/Vector3.js"></script>
<script type="text/javascript" src="../src/math/Matrix2D.js"></script>
<script type="text/javascript" src="../src/math/Matrix33.js"></script>
<script type="text/javascript" src="../src/math/Matrix44.js"></script>
<script type="text/javascript" src="../src/math/ProjectionMatrix.js"></script>
<script type="text/javascript" src="../src/math/Quaternion.js"></script>
<script type="text/javascript" src="../src/math/Vector2.js"></script>
<script type="text/javascript" src="../src/math/Vector3.js"></script>
<script type="text/javascript" src="../src/math/VectorUtil.js"></script>
<script type="text/javascript" src="../src/util/Color.js"></script>
<script type="text/javascript" src="../src/util/Error.js"></script>
<script type="text/javascript" src="../src/util/GeometryUtil.js"></script>
<script type="text/javascript" src="../src/util/Intersection.js"></script>
<script type="text/javascript" src="../src/util/MathUtil.js"></script>
<script type="text/javascript" src="../src/util/ParticleUtil.js"></script>
<script type="text/javascript" src="../src/util/ShaderUtil.js"></script>
<script type="text/javascript" src="../src/util/Time.js"></script>
<!-- J3DLIB -->

    <script type="text/javascript">

        var cv, zi = 1;
        var floor, mug, camera, engine, post, canvas;
        var mx, my;
        var debug;
        var mugHovered = false, mugDragged = false;
        var floorOrig, mugOrig;
        var startX, mugTargetX = 0;

        window.onload = function() {

            if(!J3D.Capabilities.webgl) {
                document.body.innerHTML = nowebglParagraph;
                return;
            }

            document.getElementById("v2").addEventListener('ended', function() {
                document.getElementById("v2").style.zIndex = 0;
                document.getElementById("v1").play();
            });

            document.getElementById("v3").addEventListener('ended', function() {
                document.getElementById("v3").style.zIndex = 0;
                document.getElementById("v1").play();
            });

            document.getElementById("v1").style.zIndex = 1;
            document.getElementById("gl").style.zIndex = 1000;

            debug = document.getElementById("debug");

            setTimeout(swapVideo, 8000 + Math.random() * 4000);

            startGL();
        }

        function startGL() {

            canvas = document.getElementById("gl");

            engine = new J3D.Engine(canvas, { resolution: 1 }, {
                alpha: true
            });

            engine.resize(canvas.width, canvas.height);

            J3D.Loader.loadGLSL("models/021/Noise.glsl", setupScene);
        }

        function setupScene(s) {
            post = new J3D.Postprocess(engine);
            post.filter = s;

            J3D.Loader.loadJSON("models/021/mug.json", function(jsmeshes) {
                J3D.Loader.loadJSON("models/021/mugScene.json", function(jsscene) {
                    jsscene.path = "models/021/";
                    J3D.Loader.parseJSONScene(jsscene, jsmeshes, engine);
                    engine.setClearColor(new J3D.Color(0, 0, 0, 0));

                    mug = engine.scene.find("floor/mug");

                    camera = engine.scene.find("camera");
                    // camera.rotation.z = Math.PI;

                    floor = engine.scene.find("floor");
                    floor.geometry.setTransparency(true, gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
                    floor.renderer = J3D.BuiltinShaders.fetch("Selflit");
                    floor.renderer.colorTexture = new J3D.Texture("models/021/floor.png");
                    floor.renderer.hasColorTexture = true;

                    floorOrig = floor.position.cp();
                    mugOrig = mug.position.cp();
                    mugOrigRot = mug.rotation.cp();

                    var harmonics = new J3D.Transform();
                    harmonics.light = new J3D.Light(J3D.SPHERICAL_HARMONICS);
                    engine.scene.add(harmonics);

                    document.onmousemove = onMouseMove;
                    document.onmousedown = onMouseDown;
                    document.onmouseup = onMouseUp;

                    render();
                })
            });
        }

        function onMouseDown(e) {
            if (mugHovered) {
                startX = (mx - canvas.offsetLeft) / 1024;

                TweenLite.to(mug.position, 0.3, { ease:Power2.easeOut, y:mugOrig.y + 3 });
                TweenLite.to(mug.rotation, 0.3, { ease:Power2.easeOut, z:mugOrigRot.z + 0.2 });
                TweenLite.to(floor.rotation, 0.3, { ease:Power2.easeOut, y:floor.rotation.y + (Math.random() - 0.5) });

                mugDragged = true;
            }
        }

        function onMouseUp(e) {
            if (mugDragged) {
                mugDragged = false;

                TweenLite.to(mug.position, 0.2, { ease:Power2.easeOut, y:mugOrig.y });
                TweenLite.to(mug.rotation, 0.1, { ease:Power2.easeInOut, z:mugOrigRot.z - 0.1 });
                TweenLite.to(mug.rotation, 0.2, { ease:Power2.easeOut, delay:0.08, z:mugOrigRot.z });
            }
        }

        function render() {
            requestAnimationFrame(render);

            var r = J3D.Ray.fromMousePosition(mx, my, camera, {
                x: canvas.offsetLeft,
                y: canvas.offsetTop,
                width: 1024,
                height: 576
            });

            mugHovered = J3D.Intersection.rayTest(r, mug);
            document.body.style.cursor = (mugHovered) ? "pointer" : "default";

            if (mugDragged) {
                mugTargetX += (mx / window.innerWidth - startX) * -3;
                mugTargetX = Math.max(-12, mugTargetX);
                mugTargetX = Math.min(12, mugTargetX);

                floor.position.x = floorOrig.x + mugTargetX;
                floor.rotation.y += (mx / window.innerWidth - 0.5) * -0.2;
            }

            engine.render();
        }

        function onMouseMove(e) {
            mx = e.clientX;
            my = e.clientY;
        }

        function swapVideo() {
            zi++;

            document.getElementById("v1").pause();

            var vn = "v" + (2 + zi % 2);

            document.getElementById(vn).style.zIndex = zi;
            document.getElementById(vn).play();

            setTimeout(swapVideo, 8000 + Math.random() * 4000);
        }

    </script>

</head>
<body>

<script>
    setLabels("021. Video Compositing", "Click and drag the cup to move it around");
</script>

<div id="videos">
    <video id="v2" width="1024" height="576" src="models/021/in.mp4"></video>
    <video id="v3" width="1024" height="576" src="models/021/out.mp4"></video>
    <video id="v1" width="1024" height="576" src="models/021/loop.mp4" autoplay loop></video>
    <canvas id="gl" width="1024" height="576"></canvas>
</div>

<div id="debug"></div>



</body>
</html>